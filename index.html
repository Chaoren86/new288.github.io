<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- å¾®ä¿¡å’Œç§»åŠ¨ç«¯ä¼˜åŒ– -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="format-detection" content="telephone=no, email=no, address=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="screen-orientation" content="portrait">
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    <!-- å®‰å“å¾®ä¿¡æµ®çª—æ”¯æŒ -->
    <meta name="applicable-device" content="mobile">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="320">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="theme-color" content="#667eea">
    <!-- é˜²æ­¢å¾®ä¿¡è¯†åˆ«ä¸ºæ–‡ä»¶ä¸‹è½½ - å¤šé‡å£°æ˜ -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Type" content="text/html">
    <meta name="renderer" content="webkit">
    <meta name="force-rendering" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <!-- å¾®ä¿¡ç‰¹å®šä¼˜åŒ–ï¼Œé˜²æ­¢è¢«è¯†åˆ«ä¸ºæ–‡ä»¶ -->
    <meta name="referrer" content="never">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- æ˜ç¡®å‘Šè¯‰å¾®ä¿¡è¿™æ˜¯ç½‘é¡µï¼Œä¸æ˜¯æ–‡ä»¶ - å¤šé‡å£°æ˜ -->
    <meta name="content-type" content="text/html">
    <meta name="content-type" content="text/html; charset=UTF-8">
    <meta name="media-type" content="text/html">
    <meta name="document-type" content="html">
    <meta name="mime-type" content="text/html">
    <meta name="file-type" content="html">
    <!-- å¾®ä¿¡æµè§ˆå™¨ç‰¹å®šæ ‡è¯† -->
    <meta name="x5-cache" content="false">
    <meta name="x5-page-mode" content="app">
    <meta name="x5-orientation" content="portrait">
    <!-- é¢å¤–å£°æ˜ï¼Œç¡®ä¿å¾®ä¿¡è¯†åˆ«ä¸ºç½‘é¡µ -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-itunes-app" content="app-id=">
    <meta name="apple-mobile-web-app-title" content="">
    <!-- å¾®ä¿¡åˆ†äº«ä¼˜åŒ– -->
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta property="og:type" content="website">
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:image" content="">
    <meta property="og:url" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="">
    <!-- ç¦æ­¢æ‰€æœ‰æœç´¢å¼•æ“å’Œçˆ¬è™«æŠ“å– -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex, nocache">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="slurp" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="duckduckbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="baiduspider" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="yisouSpider" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="Sogou" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="360Spider" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="Bytespider" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <!-- ç¦æ­¢QQå’Œå¾®ä¿¡çˆ¬è™« -->
    <meta name="QQBot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="TencentTraveler" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="WeChat" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="MicroMessenger" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <!-- ç¦æ­¢å…¶ä»–å¸¸è§çˆ¬è™« -->
    <meta name="spider" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="crawler" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <title></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
            overflow-y: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, "Microsoft YaHei", sans-serif;
            background: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            background: white;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œè€ƒè™‘ç§»åŠ¨ç«¯æµè§ˆå™¨å·¥å…·æ  */
            max-height: 100vh;
            max-height: 100dvh;
            position: relative;
            overflow: hidden;
            /* é˜²æ­¢é”®ç›˜å¼¹èµ·æ—¶å®¹å™¨æ»šåŠ¨ */
            overscroll-behavior: none;
            touch-action: pan-y;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-size: clamp(18px, 4vw, 24px);
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .header p {
            font-size: clamp(12px, 2.5vw, 14px);
            opacity: 0.9;
            word-break: break-all;
        }
        
        .notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px 15px;
            margin: 15px;
            text-align: center;
            font-size: clamp(12px, 2.5vw, 14px);
            flex-shrink: 0;
        }
        
        .iframe-wrapper {
            position: relative;
            flex: 1;
            min-height: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* ç¡®ä¿ç‚¹å‡»ä½ç½®å‡†ç¡® */
            transform: none;
            will-change: auto;
        }
        
        /* é‡é€‰çº¿è·¯æŒ‰é’® */
        .route-change-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 10001;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: move;
            cursor: grab;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            /* ç¡®ä¿æŒ‰é’®å¯ä»¥æ­£å¸¸ç‚¹å‡»ï¼Œä¸å½±å“iframe */
            pointer-events: auto;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
        }
        
        /* æŠ˜å çŠ¶æ€ - åªæ˜¾ç¤º"é€‰"å­— */
        .route-change-btn.collapsed {
            padding: 8px 12px;
            width: auto;
            min-width: 40px;
            border-radius: 20px 0 0 20px;
            /* é»˜è®¤é å³éšè—ï¼Œåªéœ²å‡º"é€‰"å­— */
            right: 0 !important;
            left: auto !important;
            transform: translateX(calc(100% - 40px));
        }
        
        /* å±•å¼€çŠ¶æ€ - ç«–çš„é•¿æ–¹å½¢ */
        .route-change-btn.expanded {
            transform: translateX(0);
            border-radius: 20px;
            padding: 18px 10px;
            flex-direction: column;
            width: auto;
            min-width: 50px;
        }
        
        .route-change-btn:active {
            cursor: grabbing;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }
        
        .route-change-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }
        
        .route-change-btn.dragging {
            opacity: 0.9;
            cursor: grabbing;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.7);
            /* æ‹–åŠ¨æ—¶ç¦ç”¨transitionï¼Œæå‡æ€§èƒ½ */
            transition: none !important;
            will-change: transform, left, top;
        }
        
        /* "é€‰"å­—å›¾æ ‡ */
        .route-change-btn .select-icon {
            font-size: 16px;
            font-weight: 700;
            white-space: nowrap;
            display: none;
            min-width: 20px;
            text-align: center;
            line-height: 1;
        }
        
        /* å®Œæ•´å†…å®¹ï¼ˆå›¾æ ‡+æ–‡å­—ï¼‰ */
        .route-change-btn .btn-content {
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        /* å±•å¼€çŠ¶æ€ä¸‹ï¼Œå†…å®¹ç«–å‘æ’åˆ— */
        .route-change-btn.expanded .btn-content {
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        /* æŠ˜å çŠ¶æ€ä¸‹éšè—å®Œæ•´å†…å®¹ï¼Œæ˜¾ç¤º"é€‰"å­— */
        .route-change-btn.collapsed .btn-content {
            display: none;
        }
        
        .route-change-btn.collapsed .select-icon {
            display: inline-block;
        }
        
        /* å±•å¼€çŠ¶æ€ä¸‹æ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼Œéšè—"é€‰"å­— */
        .route-change-btn.expanded .btn-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .route-change-btn.expanded .select-icon {
            display: none;
        }
        
        .route-change-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        
        /* å±•å¼€çŠ¶æ€ä¸‹å›¾æ ‡ç¨å¤§ä¸€äº› */
        .route-change-btn.expanded svg {
            width: 20px;
            height: 20px;
        }
        
        .route-change-btn span {
            white-space: nowrap;
            font-size: 12px;
        }
        
        /* å±•å¼€çŠ¶æ€ä¸‹æ–‡å­—ç¨å¤§ä¸€äº› */
        .route-change-btn.expanded span {
            font-size: 13px;
        }
        
        .iframe-container {
            position: relative;
            width: 100%;
            height: 100%;
            flex: 1;
            min-height: 0;
            background: #f5f5f5;
            overflow: hidden;
            /* ç¡®ä¿ç‚¹å‡»ä½ç½®å‡†ç¡® - Chromeæ¨¡æ‹Ÿå™¨ä¼˜åŒ– */
            touch-action: pan-x pan-y;
            /* ç¡®ä¿å®¹å™¨å®šä½å‡†ç¡®ï¼Œä¸å½±å“ç‚¹å‡» */
            transform: none;
            will-change: auto;
            /* ç¡®ä¿å®¹å™¨å°ºå¯¸å‡†ç¡® */
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            /* é˜²æ­¢å†…å®¹æº¢å‡ºå¯¼è‡´æ¨ªå‘æ»šåŠ¨ */
            max-width: 100%;
            overflow-x: hidden;
            /* Chromeæ¨¡æ‹Ÿå™¨ä¼˜åŒ– - ç¡®ä¿åæ ‡å‡†ç¡® */
            -webkit-tap-highlight-color: transparent;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            min-height: 100%;
            border: none;
            display: block;
            background: white;
            overflow: auto;
            /* ç¡®ä¿ iframe å†…å®¹å¯ä»¥å®Œæ•´æ˜¾ç¤º */
            -webkit-overflow-scrolling: touch;
            /* å¾®ä¿¡æµè§ˆå™¨ä¼˜åŒ– - ä½¿ç”¨absoluteå®šä½ç¡®ä¿ç‚¹å‡»ä½ç½®å‡†ç¡® */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* ç¡®ä¿å†…å®¹å¯ä»¥æ»šåŠ¨ */
            overscroll-behavior: contain;
            /* ç¡®ä¿ç‚¹å‡»ä½ç½®å‡†ç¡® */
            pointer-events: auto;
            touch-action: auto;
            /* ç§»é™¤å¯èƒ½å½±å“ç‚¹å‡»çš„å˜æ¢å’Œç¼©æ”¾ */
            transform: none;
            will-change: auto;
            /* ç¡®ä¿iframeå°ºå¯¸å‡†ç¡® */
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            /* ç¡®ä¿æ²¡æœ‰ç¼©æ”¾ */
            zoom: 1;
            -webkit-transform: none;
            -moz-transform: none;
            -ms-transform: none;
            -o-transform: none;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .error-message {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .error-link {
            display: inline-block;
            margin-top: 15px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .error-link:hover {
            background: #5568d3;
        }
        
        .mixed-content-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            text-align: center;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mixed-content-warning h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .mixed-content-warning p {
            color: #856404;
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .mixed-content-warning .solution {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: left;
        }
        
        .mixed-content-warning .solution strong {
            display: block;
            margin-bottom: 10px;
            color: #333;
        }
        
        .mixed-content-warning .solution ul {
            margin: 10px 0;
            padding-left: 20px;
            color: #666;
        }
        
        .mixed-content-warning .solution li {
            margin: 5px 0;
        }
        
        .footer {
            text-align: center;
            padding: 12px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
            color: #666;
            font-size: clamp(11px, 2vw, 13px);
            flex-shrink: 0;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            html, body {
                height: 100vh;
                height: 100dvh;
            }
            
            body {
                padding: 0;
            }
            
            .container {
                border-radius: 0;
                height: 100vh;
                height: 100dvh;
                max-height: 100vh;
                max-height: 100dvh;
            }
            
            .iframe-wrapper {
                height: 100%;
            }
            
            .iframe-container {
                height: 100%;
            }
            
            iframe {
                height: 100%;
                min-height: 100%;
            }
            
            .loading {
                padding: 15px 20px;
                width: 90%;
                max-width: 300px;
            }
            
            .mixed-content-warning {
                margin: 15px;
                padding: 15px;
            }
            
            .mixed-content-warning h3 {
                font-size: 16px;
            }
            
            .mixed-content-warning p {
                font-size: 13px;
            }
            
            .mixed-content-warning .solution {
                padding: 12px;
                font-size: 12px;
            }
        }
        
        /* Safari ç‰¹å®šä¼˜åŒ– */
        @supports (-webkit-touch-callout: none) {
            html, body {
                height: -webkit-fill-available;
            }
            
            .container {
                min-height: -webkit-fill-available;
            }
            
            .iframe-wrapper {
                min-height: -webkit-fill-available;
            }
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨å’ŒiOSç‰¹å®šä¼˜åŒ– */
        @supports (-webkit-touch-callout: none) {
            .iframe-container {
                height: -webkit-fill-available;
                min-height: -webkit-fill-available;
            }
            
            iframe {
                height: -webkit-fill-available;
                min-height: -webkit-fill-available;
            }
        }
        
        /* Chrome ç‰¹å®šä¼˜åŒ– */
        @media screen and (min-width: 769px) {
            .container {
                height: 100vh;
            }
        }
        
        /* è¶…å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .loading-text {
                font-size: 14px;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            /* æ¨ªå±æ¨¡å¼ç‰¹å®šæ ·å¼ */
        }
        
        /* éšè—åŠ è½½åŠ¨ç”» */
        .loading.hidden {
            display: none;
        }
        
        /* çº¿è·¯é€‰æ‹©ç•Œé¢ */
        .route-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .route-selector.hidden {
            display: none;
        }
        
        .route-selector-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: fadeInUp 0.6s ease-out;
        }
        
        .route-selector-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .route-selector-header h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .route-selector-header p {
            font-size: 14px;
            color: #666;
        }
        
        .route-section {
            margin-bottom: 25px;
        }
        
        .route-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            padding-left: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .route-section:first-child .route-section-title {
            color: #667eea;
            font-size: 15px;
        }
        
        .route-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .route-item {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .route-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .route-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .route-item.testing {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .route-item.error {
            border-color: #d32f2f;
            opacity: 0.6;
        }
        
        .route-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .route-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .route-url {
            font-size: 12px;
            color: #999;
            word-break: break-all;
        }
        
        .route-status {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: flex-end;
        }
        
        .route-latency {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 20px;
            background: #f5f5f5;
            color: #666;
        }
        
        .route-latency.fast {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .route-latency.medium {
            background: #fff3e0;
            color: #e65100;
        }
        
        .route-latency.slow {
            background: #ffebee;
            color: #c62828;
        }
        
        .route-latency.testing {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .route-latency.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .route-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .route-badge.recommended {
            background: #4caf50;
            color: white;
        }
        
        .route-badge.fastest {
            background: #2196f3;
            color: white;
        }
        
        .route-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .route-btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .route-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .route-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .route-btn-primary:active {
            transform: translateY(0);
        }
        
        .route-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .route-btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        
        .route-btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .route-refresh-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            z-index: 10;
            overflow: hidden;
        }
        
        .route-refresh-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .route-refresh-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .route-refresh-btn:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3d8f 100%);
            transform: scale(1.15) rotate(180deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .route-refresh-btn:active {
            transform: scale(1.05) rotate(180deg);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .route-refresh-btn svg {
            position: relative;
            z-index: 1;
            transition: transform 0.3s;
        }
        
        .route-refresh-btn.refreshing {
            animation: spin 1s linear infinite;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .route-refresh-btn.refreshing:hover {
            transform: scale(1.15);
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
        }
        
        .route-refresh-btn.refreshing svg {
            animation: spin 1s linear infinite;
        }
        
        @media (max-width: 768px) {
            .route-selector-content {
                padding: 20px;
                border-radius: 15px;
            }
            
            .route-selector-header h2 {
                font-size: 20px;
            }
            
            .route-item {
                padding: 14px 16px;
            }
            
            .route-name {
                font-size: 15px;
            }
            
            .route-url {
                font-size: 11px;
            }
            
            .route-section {
                margin-bottom: 20px;
            }
            
            .route-section-title {
                font-size: 13px;
                margin-bottom: 10px;
            }
            
            .route-latency {
                font-size: 12px;
                padding: 3px 10px;
            }
            
            .route-actions {
                flex-direction: column;
            }
            
            .route-btn {
                width: 100%;
            }
            
            .route-refresh-btn {
                width: 50px;
                height: 50px;
                font-size: 22px;
                top: 15px;
                right: 15px;
            }
        }
        
        /* å®‰å…¨æ£€æµ‹é¡µé¢ */
        .security-check {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }
        
        .security-check.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            display: none !important;
        }
        
        .security-check-content {
            background: white;
            border-radius: 20px;
            padding: 40px 50px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .security-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
        }
        
        .security-check-content h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
            transition: all 0.5s ease-out;
        }
        
        .security-check-content .subtitle {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .security-check-content p {
            font-size: 16px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .security-check-content .hint {
            font-size: 14px;
            color: #999;
            margin-top: 20px;
            font-style: italic;
        }
        
        /* æ£€æµ‹æ­¥éª¤ */
        .check-steps {
            margin: 30px 0;
            text-align: left;
        }
        
        .check-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.5s ease-out;
        }
        
        .check-step.active {
            opacity: 1;
            transform: translateX(0);
        }
        
        .check-step.completed {
            opacity: 0.6;
        }
        
        .step-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .check-step.active .step-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: stepPulse 1s infinite;
        }
        
        .check-step.completed .step-icon {
            background: #4caf50;
            color: white;
        }
        
        .check-step.completed .step-icon::before {
            content: 'âœ“';
        }
        
        @keyframes stepPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .step-text {
            font-size: 15px;
            color: #666;
            flex: 1;
        }
        
        .check-step.active .step-text {
            color: #333;
            font-weight: 500;
        }
        
        .check-step.completed .step-text {
            color: #999;
        }
        
        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease-out;
            border-radius: 2px;
        }
        
        /* æ£€æµ‹å®ŒæˆçŠ¶æ€ */
        .security-check-content.check-complete .check-steps {
            max-height: 0;
            opacity: 0;
            margin: 0;
            overflow: hidden;
            transition: all 0.5s ease-out;
        }
        
        .security-check-content.check-complete .progress-bar {
            opacity: 0;
            height: 0;
            margin: 0;
            transition: all 0.5s ease-out;
        }
        
        .security-check-content.check-complete .security-icon {
            background: #4caf50;
            animation: successPulse 0.6s ease-out;
            width: 100px;
            height: 100px;
            font-size: 50px;
        }
        
        @keyframes successPulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.15);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .security-check-content.check-complete h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #4caf50;
        }
        
        .security-check-content.check-complete .subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 40px;
        }
        
        .security-check-btn {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            transition: all 0.5s ease-out;
            pointer-events: none;
        }
        
        .security-check-content.check-complete .security-check-btn {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
            padding: 20px 60px;
            font-size: 20px;
        }
        
        .check-complete-message {
            font-size: 15px;
            color: #4caf50;
            margin-bottom: 25px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease-out 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .check-complete-message::before {
            content: 'âœ“';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: #4caf50;
            color: white;
            border-radius: 50%;
            line-height: 24px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .security-check-content.check-complete .check-complete-message {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* ç®€åŒ–åçš„å¸ƒå±€ */
        .security-check-content.check-complete {
            padding: 50px 40px;
        }
        
        .security-check-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            font-weight: 600;
            position: relative;
            overflow: hidden;
            animation: buttonPulse 2s infinite;
        }
        
        .security-check-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .security-check-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .security-check-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .security-check-btn:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }
            50% {
                box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
            }
        }
        
        .security-check-btn span {
            position: relative;
            z-index: 1;
        }
        
        .security-check-content .arrow-hint {
            display: inline-block;
            margin-left: 8px;
            animation: arrowBounce 1.5s infinite;
        }
        
        @keyframes arrowBounce {
            0%, 100% {
                transform: translateX(0);
            }
            50% {
                transform: translateX(5px);
            }
        }
        
        @media (max-width: 768px) {
            .security-check-content {
                padding: 30px 25px;
            }
            
            .security-check-content.check-complete {
                padding: 40px 25px;
            }
            
            .security-icon {
                width: 60px;
                height: 60px;
                font-size: 30px;
                margin-bottom: 15px;
            }
            
            .security-check-content.check-complete .security-icon {
                width: 80px;
                height: 80px;
                font-size: 40px;
            }
            
            .security-check-content h2 {
                font-size: 20px;
                margin-bottom: 12px;
            }
            
            .security-check-content.check-complete h2 {
                font-size: 22px;
                margin-bottom: 15px;
            }
            
            .security-check-content p {
                font-size: 14px;
                margin-bottom: 25px;
            }
            
            .security-check-content.check-complete .subtitle {
                font-size: 15px;
                margin-bottom: 35px;
            }
            
            .security-check-btn {
                padding: 12px 30px;
                font-size: 16px;
            }
            
            .security-check-content.check-complete .security-check-btn {
                padding: 16px 40px;
                font-size: 18px;
            }
            
            .check-complete-message {
                font-size: 14px;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- ç«‹å³è¾“å‡ºå¯è§å†…å®¹ï¼Œç¡®ä¿å¾®ä¿¡è¯†åˆ«ä¸ºHTMLé¡µé¢è€Œä¸æ˜¯æ–‡ä»¶ -->
    <!-- å¾®ä¿¡éœ€è¦ç«‹å³çœ‹åˆ°HTMLå†…å®¹æ‰èƒ½æ­£ç¡®è¯†åˆ« -->
    <div style="display:none;" id="wechat-html-marker">HTML</div>
    <!-- JavaScriptæ£€æµ‹æç¤ºï¼ˆé€šè¿‡JavaScriptæ§åˆ¶æ˜¾ç¤ºï¼‰ -->
    <div id="jsWarning" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#f5f5f5;display:none;align-items:center;justify-content:center;z-index:99999;">
        <div style="text-align:center;padding:40px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
            <h2 style="color:#d32f2f;margin-bottom:20px;">éœ€è¦å¯ç”¨JavaScript</h2>
            <p style="color:#666;line-height:1.6;">æœ¬é¡µé¢éœ€è¦JavaScriptæ”¯æŒæ‰èƒ½æ­£å¸¸è®¿é—®ã€‚</p>
            <p style="color:#999;font-size:14px;margin-top:20px;">è¯·å¯ç”¨æµè§ˆå™¨çš„JavaScriptåŠŸèƒ½ååˆ·æ–°é¡µé¢ã€‚</p>
        </div>
    </div>
    <!-- å®‰å…¨æ£€æµ‹é¡µé¢ -->
    <div id="securityCheck" class="security-check">
        <div class="security-check-content" id="securityCheckContent">
            <div class="security-icon">ğŸ”’</div>
            <h2>å®‰å…¨æ£€æµ‹ä¸­</h2>
            <div class="subtitle" id="checkSubtitle">æ­£åœ¨éªŒè¯è®¿é—®ç¯å¢ƒ...</div>
            
            <div class="check-steps">
                <div class="check-step" id="step1">
                    <div class="step-icon">1</div>
                    <div class="step-text">æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ</div>
                </div>
                <div class="check-step" id="step2">
                    <div class="step-icon">2</div>
                    <div class="step-text">éªŒè¯å®‰å…¨è¿æ¥</div>
                </div>
                <div class="check-step" id="step3">
                    <div class="step-icon">3</div>
                    <div class="step-text">æ£€æŸ¥è®¿é—®æƒé™</div>
                </div>
                <div class="check-step" id="step4">
                    <div class="step-icon">4</div>
                    <div class="step-text">å®Œæˆå®‰å…¨éªŒè¯</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>
    
    <!-- çº¿è·¯é€‰æ‹©ç•Œé¢ -->
    <div id="routeSelector" class="route-selector hidden">
        <button class="route-refresh-btn" id="routeRefreshBtn" title="é‡æ–°æ£€æµ‹å»¶è¿Ÿ">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
            </svg>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
            </svg>
        </button>
        <div class="route-selector-content">
            <div class="route-selector-header">
                <h2>è¯·é€‰æ‹©è®¿é—®çº¿è·¯</h2>
                <p>å¦‚é‡æ‰“ä¸å¼€å¤§æ¦‚ç‡æ˜¯è¢«æ‹¦æˆªå±è”½ï¼Œè¯·å°è¯•å…¶ä»–çš„çº¿è·¯ã€‚</p>
            </div>
            <div class="route-section" id="lastSelectedSection" style="display: none;">
                <div class="route-section-title">ä¸Šæ¬¡é€‰æ‹©</div>
                <div class="route-list" id="lastSelectedRouteList">
                    <!-- ä¸Šæ¬¡é€‰æ‹©çš„çº¿è·¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
            <div class="route-section" id="otherRoutesSection">
                <div class="route-section-title">å…¶ä»–çº¿è·¯</div>
                <div class="route-list" id="routeList">
                    <!-- å…¶ä»–çº¿è·¯åˆ—è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div id="mixedContentWarning" class="mixed-content-warning" style="display: none;">
            <h3>âš ï¸ æ··åˆå†…å®¹å®‰å…¨é™åˆ¶</h3>
            <p>ç”±äºæµè§ˆå™¨å®‰å…¨ç­–ç•¥ï¼ŒHTTPS é¡µé¢æ— æ³•åµŒå…¥ HTTP å†…å®¹ã€‚</p>
            <div class="solution">
                <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
                <ul>
                    <li>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨æ–°çª—å£ä¸­æ‰“å¼€ç½‘ç«™ï¼ˆæ¨èï¼‰</li>
                    <li>æˆ–è€…å°†é¡µé¢éƒ¨ç½²åˆ° HTTP ç¯å¢ƒï¼ˆé GitHub Pagesï¼‰</li>
                    <li>æˆ–è€…ä¸ºç›®æ ‡æœåŠ¡å™¨é…ç½® HTTPS è¯ä¹¦</li>
                </ul>
            </div>
            <a href="#" target="_blank" rel="noopener noreferrer" class="error-link" id="mixedContentLink" style="margin-top: 15px;">åœ¨æ–°çª—å£ä¸­æ‰“å¼€ç½‘ç«™</a>
        </div>
        <div class="iframe-wrapper" id="iframeWrapper">
            <!-- é‡é€‰çº¿è·¯æŒ‰é’® -->
            <button class="route-change-btn collapsed" id="routeChangeBtn" title="é‡é€‰çº¿è·¯ï¼ˆå¯æ‹–åŠ¨ï¼‰" style="display: none;">
                <!-- æŠ˜å çŠ¶æ€æ˜¾ç¤ºçš„"é€‰"å­— -->
                <span class="select-icon">é€‰</span>
                <!-- å±•å¼€çŠ¶æ€æ˜¾ç¤ºçš„å®Œæ•´å†…å®¹ -->
                <div class="btn-content">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z" fill="currentColor"/>
                    </svg>
                    <span>é‡é€‰çº¿è·¯</span>
                </div>
            </button>
            <div class="iframe-container">
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">æ­£åœ¨åŠ è½½ç½‘ç«™...</div>
                </div>
                <iframe 
                    id="mainFrame"
                    title="ç¬¬ä¸‰æ–¹ç½‘ç«™å†…å®¹"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen"
                    allowfullscreen
                    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-top-navigation-by-user-activation allow-modals"
                    referrerpolicy="no-referrer-when-downgrade"
                    loading="lazy"
                    scrolling="yes"
                    style="overflow: auto; -webkit-overflow-scrolling: touch;">
                    <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒiframeã€‚è¯·<a href="#" target="_blank" rel="noopener noreferrer" id="fallbackLink">ç‚¹å‡»è¿™é‡Œ</a>åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚</p>
                </iframe>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';
            
            // æ£€æµ‹å¾®ä¿¡ç¯å¢ƒ
            const isWeChat = /micromessenger/i.test(navigator.userAgent);
            const isQQ = /mqqbrowser|qzone|qqbrowser/i.test(navigator.userAgent);
            
            // å¾®ä¿¡/QQç¯å¢ƒç‰¹æ®Šå¤„ç†ï¼šç«‹å³æ¸²æŸ“é¡µé¢å†…å®¹ï¼Œé˜²æ­¢è¢«è¯†åˆ«ä¸ºæ–‡ä»¶
            if (isWeChat || isQQ) {
                // å¼ºåˆ¶ç«‹å³æ˜¾ç¤ºbodyå†…å®¹
                if (document.body) {
                    document.body.style.visibility = 'visible';
                    document.body.style.display = 'block';
                    document.body.style.opacity = '1';
                }
                // ç¡®ä¿HTMLå…ƒç´ å¯è§
                if (document.documentElement) {
                    document.documentElement.style.visibility = 'visible';
                    document.documentElement.style.display = 'block';
                }
                // ç«‹å³è§¦å‘é‡ç»˜å’Œå›æµï¼Œç¡®ä¿å¾®ä¿¡è¯†åˆ«ä¸ºHTML
                if (document.body) {
                    // å¼ºåˆ¶è§¦å‘é‡ç»˜
                    const forceRepaint = document.body.offsetHeight;
                    // ç¡®ä¿æœ‰å†…å®¹é«˜åº¦
                    if (document.body.offsetHeight === 0) {
                        document.body.style.minHeight = '1px';
                        setTimeout(function() {
                            if (document.body) {
                                document.body.style.minHeight = '';
                            }
                        }, 0);
                    }
                }
                // ç¡®ä¿å®‰å…¨æ£€æµ‹é¡µé¢ç«‹å³å¯è§
                const securityCheck = document.getElementById('securityCheck');
                if (securityCheck) {
                    securityCheck.style.display = 'flex';
                    securityCheck.style.visibility = 'visible';
                    securityCheck.style.opacity = '1';
                }
                // å¼ºåˆ¶è§¦å‘ä¸€æ¬¡é‡ç»˜
                if (window.requestAnimationFrame) {
                    requestAnimationFrame(function() {
                        if (document.body) {
                            document.body.style.display = document.body.style.display || 'block';
                        }
                    });
                }
            }
            
            // ç«‹å³éšè—JavaScriptè­¦å‘Šï¼ˆå¦‚æœJavaScriptèƒ½è¿è¡Œï¼Œè¯´æ˜å·²å¯ç”¨ï¼‰
            (function() {
                const jsWarning = document.getElementById('jsWarning');
                if (jsWarning) {
                    jsWarning.style.display = 'none';
                }
            })();
            
            // åçˆ¬è™«æ£€æµ‹ - æ£€æµ‹User-Agent
            function detectCrawler() {
                const userAgent = navigator.userAgent || '';
                const ua = userAgent.toLowerCase();
                
                // å…è®¸çš„æ­£å¸¸æµè§ˆå™¨User-Agentå…³é”®è¯ï¼ˆè¿™äº›ä¸åº”è¯¥è¢«é˜»æ­¢ï¼‰
                const allowedBrowsers = [
                    'micromessenger',  // å¾®ä¿¡å†…ç½®æµè§ˆå™¨
                    'wechat',          // å¾®ä¿¡æµè§ˆå™¨
                    'qqbrowser',       // QQæµè§ˆå™¨
                    'mqqbrowser',      // ç§»åŠ¨QQæµè§ˆå™¨
                    'tencenttraveler'  // è…¾è®¯æµè§ˆå™¨
                ];
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸çš„æµè§ˆå™¨ï¼ˆåŒ…å«å…è®¸çš„å…³é”®è¯ï¼‰
                let isAllowedBrowser = false;
                for (let i = 0; i < allowedBrowsers.length; i++) {
                    if (ua.indexOf(allowedBrowsers[i]) !== -1) {
                        isAllowedBrowser = true;
                        break;
                    }
                }
                
                // å¦‚æœæ˜¯æ­£å¸¸æµè§ˆå™¨ï¼Œç›´æ¥å…è®¸è®¿é—®
                if (isAllowedBrowser) {
                    return false;
                }
                
                // æ˜ç¡®çš„çˆ¬è™«å…³é”®è¯åˆ—è¡¨ï¼ˆåªæ£€æµ‹çœŸæ­£çš„çˆ¬è™«ï¼‰
                const crawlerKeywords = [
                    // æœç´¢å¼•æ“çˆ¬è™«ï¼ˆæ˜ç¡®çš„botæ ‡è¯†ï¼‰
                    'googlebot',
                    'bingbot',
                    'slurp',
                    'duckduckbot',
                    'baiduspider',
                    'yisouspider',
                    'sogou web spider',
                    'sogou inst spider',
                    '360spider',
                    'bytespider',
                    'yandexbot',
                    'facebookexternalhit',
                    'facebookbot',
                    'twitterbot',
                    'linkedinbot',
                    'telegrambot',
                    // æ˜ç¡®çš„çˆ¬è™«æ ‡è¯†ï¼ˆå¿…é¡»åŒ…å«bot/spider/crawlerç­‰ï¼‰
                    'spider',
                    'crawler',
                    'bot',
                    'scraper',
                    'spiderbot',
                    'crawlbot',
                    // è‡ªåŠ¨åŒ–å·¥å…·å’Œçˆ¬è™«æ¡†æ¶
                    'python-requests',
                    'scrapy',
                    'headless',
                    'phantom',
                    'selenium',
                    'puppeteer',
                    'playwright',
                    'cheerio',
                    // HTTPå®¢æˆ·ç«¯ï¼ˆå¯èƒ½æ˜¯çˆ¬è™«ï¼‰
                    'wget',
                    'curl',
                    'java/',
                    'go-http-client',
                    'httpclient',
                    'apache-httpclient',
                    'okhttp',
                    'node-fetch',
                    'axios'
                ];
                
                // æ£€æµ‹æ˜¯å¦ä¸ºæ˜ç¡®çš„çˆ¬è™«ï¼ˆå¿…é¡»åŒ…å«æ˜ç¡®çš„çˆ¬è™«å…³é”®è¯ï¼‰
                for (let i = 0; i < crawlerKeywords.length; i++) {
                    if (ua.indexOf(crawlerKeywords[i]) !== -1) {
                        // å¯¹äºbot/spider/crawlerè¿™äº›é€šç”¨è¯ï¼Œéœ€è¦æ›´ä¸¥æ ¼çš„åˆ¤æ–­
                        if (crawlerKeywords[i] === 'bot' || crawlerKeywords[i] === 'spider' || crawlerKeywords[i] === 'crawler') {
                            // æ£€æŸ¥æ˜¯å¦çœŸçš„æ˜¯çˆ¬è™«ï¼ˆUser-Agentä¸­æ˜ç¡®åŒ…å«bot/spider/crawlerï¼Œä¸”ä¸æ˜¯æ­£å¸¸æµè§ˆå™¨ï¼‰
                            // æ­£å¸¸æµè§ˆå™¨çš„User-Agenté€šå¸¸åŒ…å«chrome/safari/firefoxç­‰
                            const hasBrowserMarker = ua.indexOf('chrome') !== -1 || 
                                                    ua.indexOf('safari') !== -1 || 
                                                    ua.indexOf('firefox') !== -1 ||
                                                    ua.indexOf('edge') !== -1 ||
                                                    ua.indexOf('opera') !== -1;
                            // å¦‚æœåŒ…å«bot/spider/crawlerä½†æ²¡æœ‰æ­£å¸¸æµè§ˆå™¨æ ‡è¯†ï¼Œåˆ¤å®šä¸ºçˆ¬è™«
                            if (!hasBrowserMarker) {
                                return true;
                            }
                        } else {
                            // å…¶ä»–æ˜ç¡®çš„çˆ¬è™«å…³é”®è¯ï¼ˆå¦‚googlebotã€seleniumç­‰ï¼‰ï¼Œç›´æ¥åˆ¤å®šä¸ºçˆ¬è™«
                            return true;
                        }
                    }
                }
                
                // æ£€æµ‹è‡ªåŠ¨åŒ–å·¥å…·ç‰¹å¾ï¼ˆwebdriveræ˜¯seleniumç­‰è‡ªåŠ¨åŒ–å·¥å…·çš„æ ‡å¿—ï¼‰
                // ä½†å…è®¸æ­£å¸¸çš„Chromeæµè§ˆå™¨ï¼ˆå³ä½¿æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼‰
                if (navigator.webdriver) {
                    // å¦‚æœåŒæ—¶æ»¡è¶³å¤šä¸ªå¯ç–‘æ¡ä»¶ï¼Œæ‰åˆ¤å®šä¸ºçˆ¬è™«
                    // å•ç‹¬webdriverå±æ€§å¯èƒ½æ˜¯å¼€å‘è€…å·¥å…·ï¼Œä¸ç›´æ¥é˜»æ­¢
                    const suspiciousCount = 0;
                    // æ£€æŸ¥æ˜¯å¦çœŸçš„æ˜¯è‡ªåŠ¨åŒ–å·¥å…·ï¼ˆç»“åˆå…¶ä»–ç‰¹å¾ï¼‰
                    if (!window.chrome || !navigator.plugins || navigator.plugins.length === 0) {
                        return true;
                    }
                }
                
                // æ£€æµ‹å±å¹•å°ºå¯¸å¼‚å¸¸ï¼ˆæ— å¤´æµè§ˆå™¨é€šå¸¸æœ‰å›ºå®šå°ºå¯¸ï¼‰
                // ä½†å…è®¸æ­£å¸¸çš„æµè§ˆå™¨ï¼ˆå³ä½¿çª—å£å¾ˆå°ï¼‰
                if (window.screen && window.screen.width > 0 && window.screen.height > 0) {
                    // å±å¹•å°ºå¯¸æ­£å¸¸ï¼Œç»§ç»­æ£€æµ‹
                } else if (window.screen && (window.screen.width === 0 || window.screen.height === 0)) {
                    // å±å¹•å°ºå¯¸ä¸º0ï¼Œç»“åˆå…¶ä»–ç‰¹å¾åˆ¤æ–­
                    if (navigator.webdriver || ua.indexOf('headless') !== -1) {
                        return true;
                    }
                }
                
                // æ£€æµ‹è¯­è¨€è®¾ç½®å¼‚å¸¸ï¼ˆçœŸæ­£çš„æµè§ˆå™¨åº”è¯¥æœ‰è¯­è¨€è®¾ç½®ï¼‰
                if (!navigator.language && !navigator.languages) {
                    // ç»“åˆå…¶ä»–ç‰¹å¾åˆ¤æ–­
                    if (navigator.webdriver || ua.indexOf('headless') !== -1) {
                        return true;
                    }
                }
                
                // æ£€æµ‹æ—¶åŒºå¼‚å¸¸ï¼ˆçœŸæ­£çš„æµè§ˆå™¨åº”è¯¥æœ‰æ—¶åŒºï¼‰
                try {
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    if (!timezone) {
                        // ç»“åˆå…¶ä»–ç‰¹å¾åˆ¤æ–­
                        if (navigator.webdriver || ua.indexOf('headless') !== -1) {
                            return true;
                        }
                    }
                } catch (e) {
                    // æ—¶åŒºæ£€æµ‹å¤±è´¥ï¼Œä¸ç›´æ¥åˆ¤å®šä¸ºçˆ¬è™«
                }
                
                return false;
            }
            
            // å¦‚æœæ£€æµ‹åˆ°çˆ¬è™«ï¼Œé˜»æ­¢è®¿é—®
            if (detectCrawler()) {
                // æ¸…ç©ºé¡µé¢å†…å®¹
                document.body.innerHTML = '';
                document.body.style.cssText = 'margin:0;padding:0;background:#f5f5f5;display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial,sans-serif;';
                document.body.innerHTML = '<div style="text-align:center;padding:40px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);"><h2 style="color:#d32f2f;margin-bottom:20px;">è®¿é—®è¢«æ‹’ç»</h2><p style="color:#666;line-height:1.6;">æŠ±æ­‰ï¼Œæœ¬é¡µé¢ä¸å…è®¸è‡ªåŠ¨åŒ–å·¥å…·è®¿é—®ã€‚</p><p style="color:#999;font-size:14px;margin-top:20px;">è¯·ä½¿ç”¨æ­£å¸¸çš„æµè§ˆå™¨è®¿é—®ã€‚</p></div>';
                // é˜»æ­¢åç»­è„šæœ¬æ‰§è¡Œ
                throw new Error('Crawler detected');
            }
            
            // è·å–DOMå…ƒç´ 
            const iframe = document.getElementById('mainFrame');
            const loading = document.getElementById('loading');
            const iframeWrapper = document.getElementById('iframeWrapper');
            const mixedContentWarning = document.getElementById('mixedContentWarning');
            const securityCheck = document.getElementById('securityCheck');
            const routeSelector = document.getElementById('routeSelector');
            const routeList = document.getElementById('routeList');
            const routeRefreshBtn = document.getElementById('routeRefreshBtn');
            const routeChangeBtn = document.getElementById('routeChangeBtn');
            
            // å˜é‡åˆå§‹åŒ–
            let loadTimeout;
            let hasLoaded = false;
            let errorDetected = false;
            let checkCount = 0;
            const maxChecks = 20; // æœ€å¤šæ£€æŸ¥20æ¬¡ï¼ˆ10ç§’ï¼‰
            
            // ============================================
            // çº¿è·¯é…ç½®åŒºåŸŸ - åœ¨è¿™é‡Œé…ç½®æ‰€æœ‰å¯ç”¨çš„çº¿è·¯
            // ============================================
            // æ³¨æ„ï¼šæ‰€æœ‰URLéƒ½ç»Ÿä¸€åœ¨è¿™é‡Œé…ç½®ï¼Œä»£ç ä¸­ä¸å†ç¡¬ç¼–ç URL
            // æ·»åŠ æ–°çº¿è·¯ï¼šå¤åˆ¶ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œä¿®æ”¹idã€nameã€urlå’Œdescriptionå³å¯
            const routeConfig = [
                {
                    id: 'route1',
                    name: 'çº¿è·¯ä¸€',
                    url: 'https://47.86.49.52:1188',  // ä¸»çº¿è·¯URL
                    description: 'ä¸»çº¿è·¯'
                },
                {
                    id: 'route2',
                    name: 'çº¿è·¯äºŒ',
                    url: 'https://rzgkzx.com',  // å¤‡ç”¨çº¿è·¯ä¸€URL
                    description: 'å¤‡ç”¨çº¿è·¯ä¸€'
                },
                {
                    id: 'route3',
                    name: 'çº¿è·¯ä¸‰',
                    url: 'https://z6zo20.cn',  // å¤‡ç”¨çº¿è·¯äºŒURL
                    description: 'å¤‡ç”¨çº¿è·¯äºŒ'
                },
                {
                    id: 'route3',
                    name: 'çº¿è·¯å››',
                    url: 'https://ux293.cn/',  // å¤‡ç”¨çº¿è·¯äºŒURL
                    description: 'å¤‡ç”¨çº¿è·¯ä¸‰'
                }
                // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šçº¿è·¯ï¼Œä¾‹å¦‚ï¼š
                // {
                //     id: 'route4',
                //     name: 'çº¿è·¯å››',
                //     url: 'https://your-backup-url.com',
                //     description: 'å¤‡ç”¨çº¿è·¯ä¸‰'
                // }
            ];
            
            // å½“å‰é€‰ä¸­çš„çº¿è·¯
            let selectedRoute = null;
            let routeLatencies = {}; // å­˜å‚¨å„çº¿è·¯çš„å»¶è¿Ÿä¿¡æ¯
            
            // å­˜å‚¨é”®å
            const STORAGE_KEY_ROUTE = 'selectedRouteId';
            const STORAGE_KEY_URL_PARAMS = 'iframeUrlParams';
            
            // ä»localStorageæ¢å¤é€‰æ‹©çš„çº¿è·¯
            function restoreSelectedRoute() {
                try {
                    const savedRouteId = localStorage.getItem(STORAGE_KEY_ROUTE);
                    if (savedRouteId) {
                        const route = routeConfig.find(function(r) {
                            return r.id === savedRouteId;
                        });
                        if (route) {
                            selectedRoute = route;
                            iframeBaseUrl = route.url;
                            return true;
                        }
                    }
                } catch (e) {
                    console.warn('æ— æ³•è¯»å–localStorage:', e);
                }
                return false;
            }
            
            // ä¿å­˜é€‰æ‹©çš„çº¿è·¯åˆ°localStorage
            function saveSelectedRoute(route) {
                try {
                    if (route && route.id) {
                        localStorage.setItem(STORAGE_KEY_ROUTE, route.id);
                    }
                } catch (e) {
                    console.warn('æ— æ³•ä¿å­˜åˆ°localStorage:', e);
                }
            }
            
            // ä¿å­˜URLå‚æ•°åˆ°localStorage
            function saveUrlParams() {
                try {
                    const param = getQueryParam() || getCurrentHash();
                    if (param) {
                        localStorage.setItem(STORAGE_KEY_URL_PARAMS, param);
                    } else {
                        localStorage.removeItem(STORAGE_KEY_URL_PARAMS);
                    }
                } catch (e) {
                    console.warn('æ— æ³•ä¿å­˜URLå‚æ•°åˆ°localStorage:', e);
                }
            }
            
            // ä»localStorageæ¢å¤URLå‚æ•°
            function restoreUrlParams() {
                try {
                    const savedParams = localStorage.getItem(STORAGE_KEY_URL_PARAMS);
                    if (savedParams) {
                        // å¦‚æœå½“å‰URLæ²¡æœ‰å‚æ•°ï¼Œä½¿ç”¨ä¿å­˜çš„å‚æ•°
                        const currentParam = getQueryParam() || getCurrentHash();
                        if (!currentParam && savedParams) {
                            // å¦‚æœæ˜¯hashæ ¼å¼ï¼Œç›´æ¥è®¾ç½®hash
                            if (savedParams.startsWith('#')) {
                                window.location.hash = savedParams;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('æ— æ³•è¯»å–URLå‚æ•°:', e);
                }
            }
            
            // iframeåŸºç¡€URLï¼ˆå°†æ ¹æ®é€‰æ‹©çš„çº¿è·¯åŠ¨æ€è®¾ç½®ï¼‰
            // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªçº¿è·¯çš„URLï¼Œä½†å¦‚æœlocalStorageä¸­æœ‰ä¿å­˜ï¼Œåˆ™ä½¿ç”¨ä¿å­˜çš„
            let iframeBaseUrl = routeConfig.length > 0 ? routeConfig[0].url : '';
            
            // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„çº¿è·¯
            const hasSavedRoute = restoreSelectedRoute();
            if (hasSavedRoute) {
                // æ¢å¤URLå‚æ•°
                restoreUrlParams();
            }
            
            // è·å–å½“å‰ä½¿ç”¨çš„URLï¼ˆç”¨äºæ›´æ–°é“¾æ¥ç­‰ï¼‰
            function getCurrentUrl() {
                return iframeBaseUrl || (routeConfig.length > 0 ? routeConfig[0].url : '');
            }
            
            // è·å–å½“å‰é¡µé¢çš„hashå‚æ•°
            function getCurrentHash() {
                const hash = window.location.hash;
                return hash && hash.length > 1 ? hash : '';
            }
            
            // è·å–å½“å‰é¡µé¢çš„æŸ¥è¯¢å‚æ•°ï¼ˆè½¬æ¢ä¸ºhashæ ¼å¼ï¼‰
            function getQueryParam() {
                const search = window.location.search;
                if (search) {
                    const params = new URLSearchParams(search);
                    const agentCode = params.get('agent_code');
                    if (agentCode) {
                        // è½¬æ¢ä¸ºhashæ ¼å¼
                        return '#/?agent_code=' + agentCode;
                    }
                }
                return '';
            }
            
            // æ„å»ºå®Œæ•´çš„iframe URL
            function buildIframeUrl(baseUrl) {
                const url = baseUrl || getCurrentUrl();
                if (!url) return '';
                
                // ä¼˜å…ˆä½¿ç”¨æŸ¥è¯¢å‚æ•°ï¼ˆå·²è½¬æ¢ä¸ºhashæ ¼å¼ï¼‰
                const queryParam = getQueryParam();
                if (queryParam) {
                    return url + '/' + queryParam;
                }
                
                // å¦‚æœæ²¡æœ‰æŸ¥è¯¢å‚æ•°ï¼Œä½¿ç”¨hashå‚æ•°
                const hash = getCurrentHash();
                if (hash) {
                    return url + '/' + hash;
                }
                
                return url;
            }
            
            // æ›´æ–°æ‰€æœ‰é“¾æ¥çš„URLï¼ˆå½“çº¿è·¯æ”¹å˜æ—¶è°ƒç”¨ï¼‰
            function updateAllLinks() {
                const currentUrl = getCurrentUrl();
                const param = getQueryParam() || getCurrentHash();
                const fullUrl = currentUrl + param;
                
                // æ›´æ–°mixedContentLink
                const mixedContentLink = document.getElementById('mixedContentLink');
                if (mixedContentLink) {
                    mixedContentLink.href = fullUrl;
                }
                
                // æ›´æ–°fallbackLink
                const fallbackLink = document.getElementById('fallbackLink');
                if (fallbackLink) {
                    fallbackLink.href = fullUrl;
                }
                
                // æ›´æ–°æ‰€æœ‰é”™è¯¯é“¾æ¥
                const errorLinks = document.querySelectorAll('.error-link');
                errorLinks.forEach(function(link) {
                    if (link.id !== 'mixedContentLink' && link.id !== 'fallbackLink') {
                        link.href = fullUrl;
                    }
                });
            }
            
            // æ£€æµ‹URLå»¶è¿Ÿ
            function testRouteLatency(route) {
                return new Promise(function(resolve) {
                    const startTime = performance.now();
                    const testUrl = route.url + '/favicon.ico?' + Date.now();
                    
                    // ä½¿ç”¨Imageå¯¹è±¡æµ‹è¯•ï¼ˆè·¨åŸŸå‹å¥½ï¼‰
                    const img = new Image();
                    let resolved = false;
                    
                    const timeout = setTimeout(function() {
                        if (!resolved) {
                            resolved = true;
                            resolve({
                                route: route,
                                latency: null,
                                error: 'timeout',
                                status: 'error'
                            });
                        }
                    }, 5000); // 5ç§’è¶…æ—¶
                    
                    img.onload = function() {
                        if (!resolved) {
                            resolved = true;
                            clearTimeout(timeout);
                            const latency = Math.round(performance.now() - startTime);
                            resolve({
                                route: route,
                                latency: latency,
                                error: null,
                                status: 'success'
                            });
                        }
                    };
                    
                    img.onerror = function() {
                        if (!resolved) {
                            resolved = true;
                            clearTimeout(timeout);
                            // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿè®°å½•æ—¶é—´ï¼ˆå¯èƒ½æœåŠ¡å™¨ä¸æ”¯æŒfaviconï¼Œä½†èƒ½å“åº”ï¼‰
                            const latency = Math.round(performance.now() - startTime);
                            resolve({
                                route: route,
                                latency: latency < 5000 ? latency : null,
                                error: latency < 5000 ? null : 'timeout',
                                status: latency < 5000 ? 'success' : 'error'
                            });
                        }
                    };
                    
                    // å°è¯•ä½¿ç”¨fetch APIï¼ˆæ›´å‡†ç¡®ï¼Œä½†å¯èƒ½å—CORSé™åˆ¶ï¼‰
                    if (typeof fetch !== 'undefined') {
                        fetch(testUrl, {
                            method: 'HEAD',
                            mode: 'no-cors',
                            cache: 'no-cache'
                        }).then(function() {
                            if (!resolved) {
                                resolved = true;
                                clearTimeout(timeout);
                                const latency = Math.round(performance.now() - startTime);
                                resolve({
                                    route: route,
                                    latency: latency,
                                    error: null,
                                    status: 'success'
                                });
                            }
                        }).catch(function() {
                            // fetchå¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨imgæ–¹å¼
                        });
                    }
                    
                    img.src = testUrl;
                });
            }
            
            // æ£€æµ‹æ‰€æœ‰çº¿è·¯çš„å»¶è¿Ÿ
            async function testAllRoutes() {
                const promises = routeConfig.map(function(route) {
                    return testRouteLatency(route);
                });
                
                const results = await Promise.all(promises);
                
                // å­˜å‚¨å»¶è¿Ÿç»“æœ
                results.forEach(function(result) {
                    routeLatencies[result.route.id] = result;
                });
                
                // æ‰¾åˆ°æœ€å¿«çš„çº¿è·¯
                const successfulResults = results.filter(function(r) {
                    return r.status === 'success' && r.latency !== null;
                });
                
                if (successfulResults.length > 0) {
                    successfulResults.sort(function(a, b) {
                        return a.latency - b.latency;
                    });
                    return successfulResults[0].route;
                }
                
                // å¦‚æœæ²¡æœ‰æˆåŠŸçš„ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
                return routeConfig[0];
            }
            
            // åˆ›å»ºçº¿è·¯é¡¹å…ƒç´ 
            function createRouteItem(route, fastestRoute) {
                const latency = routeLatencies[route.id];
                const routeItem = document.createElement('div');
                routeItem.className = 'route-item';
                routeItem.dataset.routeId = route.id;
                
                if (selectedRoute && selectedRoute.id === route.id) {
                    routeItem.classList.add('selected');
                }
                
                if (latency && latency.status === 'testing') {
                    routeItem.classList.add('testing');
                }
                
                if (latency && latency.status === 'error') {
                    routeItem.classList.add('error');
                }
                
                let latencyHtml = '';
                if (latency) {
                    if (latency.status === 'testing') {
                        latencyHtml = '<span class="route-latency testing">æ£€æµ‹ä¸­...</span>';
                    } else if (latency.status === 'error') {
                        latencyHtml = '<span class="route-latency error">è¿æ¥å¤±è´¥</span>';
                    } else if (latency.latency !== null) {
                        const latencyClass = latency.latency < 500 ? 'fast' : (latency.latency < 1500 ? 'medium' : 'slow');
                        latencyHtml = '<span class="route-latency ' + latencyClass + '">' + latency.latency + 'ms</span>';
                    } else {
                        latencyHtml = '<span class="route-latency">æœªçŸ¥</span>';
                    }
                } else {
                    latencyHtml = '<span class="route-latency testing">ç­‰å¾…æ£€æµ‹...</span>';
                }
                
                let badgeHtml = '';
                if (fastestRoute && route.id === fastestRoute.id && latency && latency.status === 'success') {
                    badgeHtml = '<span class="route-badge fastest">æœ€å¿«</span>';
                }
                
                routeItem.innerHTML = '<div class="route-info">' +
                    '<div class="route-name">' + route.name + badgeHtml + '</div>' +
                    '</div>' +
                    '<div class="route-status">' + latencyHtml + '</div>';
                
                routeItem.addEventListener('click', function() {
                    if (latency && latency.status === 'testing') return;
                    if (latency && latency.status === 'error') return; // è¿æ¥å¤±è´¥çš„çº¿è·¯ä¸èƒ½é€‰æ‹©
                    
                    // ç›´æ¥é€‰æ‹©å¹¶è¿›å…¥è¯¥çº¿è·¯
                    selectedRoute = route;
                    confirmRouteSelection();
                });
                
                return routeItem;
            }
            
            // æ¸²æŸ“çº¿è·¯åˆ—è¡¨
            function renderRouteList() {
                const routeList = document.getElementById('routeList');
                const lastSelectedRouteList = document.getElementById('lastSelectedRouteList');
                const lastSelectedSection = document.getElementById('lastSelectedSection');
                const otherRoutesSection = document.getElementById('otherRoutesSection');
                
                if (!routeList || !lastSelectedRouteList) return;
                
                // æ¸…ç©ºåˆ—è¡¨
                routeList.innerHTML = '';
                lastSelectedRouteList.innerHTML = '';
                
                // è·å–ä¸Šæ¬¡é€‰æ‹©çš„çº¿è·¯ID
                let lastSelectedRouteId = null;
                try {
                    lastSelectedRouteId = localStorage.getItem(STORAGE_KEY_ROUTE);
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯
                }
                
                // æ‰¾åˆ°ä¸Šæ¬¡é€‰æ‹©çš„çº¿è·¯
                const lastSelectedRoute = lastSelectedRouteId ? routeConfig.find(function(r) {
                    return r.id === lastSelectedRouteId;
                }) : null;
                
                // åˆ†ç¦»çº¿è·¯ï¼šä¸Šæ¬¡é€‰æ‹©çš„å’Œå…¶ä»–çš„
                const otherRoutes = routeConfig.filter(function(route) {
                    return !lastSelectedRoute || route.id !== lastSelectedRoute.id;
                });
                
                // æŒ‰å»¶è¿Ÿæ’åºå…¶ä»–çº¿è·¯ï¼ˆæˆåŠŸçš„åœ¨å‰ï¼ŒæŒ‰å»¶è¿Ÿå‡åºï¼‰
                const sortedOtherRoutes = otherRoutes.slice().sort(function(a, b) {
                    const latencyA = routeLatencies[a.id];
                    const latencyB = routeLatencies[b.id];
                    
                    if (!latencyA || latencyA.status !== 'success') return 1;
                    if (!latencyB || latencyB.status !== 'success') return -1;
                    
                    return (latencyA.latency || 9999) - (latencyB.latency || 9999);
                });
                
                // æ‰¾åˆ°æœ€å¿«çš„çº¿è·¯ï¼ˆåœ¨æ‰€æœ‰çº¿è·¯ä¸­ï¼‰
                const allRoutes = lastSelectedRoute ? [lastSelectedRoute, ...otherRoutes] : otherRoutes;
                const fastestRoute = allRoutes.find(function(route) {
                    const latency = routeLatencies[route.id];
                    return latency && latency.status === 'success' && latency.latency !== null;
                });
                
                // æ¸²æŸ“ä¸Šæ¬¡é€‰æ‹©çš„çº¿è·¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (lastSelectedRoute) {
                    lastSelectedSection.style.display = 'block';
                    const routeItem = createRouteItem(lastSelectedRoute, fastestRoute);
                    lastSelectedRouteList.appendChild(routeItem);
                } else {
                    lastSelectedSection.style.display = 'none';
                }
                
                // æ¸²æŸ“å…¶ä»–çº¿è·¯
                sortedOtherRoutes.forEach(function(route) {
                    routeList.appendChild(createRouteItem(route, fastestRoute));
                });
            }
            
            // æ˜¾ç¤ºçº¿è·¯é€‰æ‹©ç•Œé¢
            function showRouteSelector() {
                if (!routeSelector) return;
                
                // å¦‚æœåªæœ‰ä¸€ä¸ªçº¿è·¯ï¼Œç›´æ¥ä½¿ç”¨ï¼Œä¸æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                if (routeConfig.length === 1) {
                    selectedRoute = routeConfig[0];
                    iframeBaseUrl = selectedRoute.url;
                    // ä¿å­˜é€‰æ‹©çš„çº¿è·¯
                    saveSelectedRoute(selectedRoute);
                    saveUrlParams();
                    
                    if (iframeWrapper) {
                        iframeWrapper.style.display = '';
                    }
                    // æ›´æ–°æ‰€æœ‰é“¾æ¥
                    updateAllLinks();
                    // åªæœ‰åœ¨é€‰æ‹©çº¿è·¯åæ‰è®¾ç½®iframeçš„src
                    if (iframe) {
                        updateIframeUrl();
                    }
                    setTimeout(updateIframeHeight, 100);
                    return;
                }
                
                routeSelector.classList.remove('hidden');
                // éšè—é‡æ–°é€‰æ‹©çº¿è·¯æŒ‰é’®ï¼ˆæ˜¾ç¤ºé€‰æ‹©ç•Œé¢æ—¶ï¼‰
                if (routeChangeBtn) {
                    routeChangeBtn.style.display = 'none';
                }
                selectedRoute = null;
                routeLatencies = {};
                
                // åˆå§‹æ¸²æŸ“
                renderRouteList();
                
                // å¼€å§‹æ£€æµ‹å»¶è¿Ÿ
                routeConfig.forEach(function(route) {
                    routeLatencies[route.id] = {
                        route: route,
                        latency: null,
                        error: null,
                        status: 'testing'
                    };
                });
                renderRouteList();
                
                // æ£€æµ‹æ‰€æœ‰çº¿è·¯
                testAllRoutes().then(function(fastestRoute) {
                    // è‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„çº¿è·¯ï¼ˆä½†ä¸è‡ªåŠ¨è¿›å…¥ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ï¼‰
                    if (fastestRoute && !selectedRoute) {
                        selectedRoute = fastestRoute;
                        const routeItem = document.querySelector('[data-route-id="' + fastestRoute.id + '"]');
                        if (routeItem) {
                            routeItem.classList.add('selected');
                        }
                    }
                    renderRouteList();
                });
            }
            
            // éšè—çº¿è·¯é€‰æ‹©ç•Œé¢
            function hideRouteSelector() {
                if (routeSelector) {
                    routeSelector.classList.add('hidden');
                }
            }
            
            // ç¡®è®¤é€‰æ‹©çº¿è·¯
            function confirmRouteSelection() {
                if (!selectedRoute) return;
                
                iframeBaseUrl = selectedRoute.url;
                
                // ä¿å­˜é€‰æ‹©çš„çº¿è·¯åˆ°localStorage
                saveSelectedRoute(selectedRoute);
                
                // ä¿å­˜URLå‚æ•°
                saveUrlParams();
                
                hideRouteSelector();
                
                // æ›´æ–°æ‰€æœ‰é“¾æ¥
                updateAllLinks();
                
                // æ˜¾ç¤ºiframeå®¹å™¨
                if (iframeWrapper) {
                    iframeWrapper.style.display = '';
                }
                
                // æ˜¾ç¤ºé‡æ–°é€‰æ‹©çº¿è·¯æŒ‰é’®
                if (routeChangeBtn) {
                    routeChangeBtn.style.display = 'flex';
                }
                
                // åªæœ‰åœ¨ç”¨æˆ·é€‰æ‹©çº¿è·¯åæ‰è®¾ç½®iframeçš„srcå¹¶å¼€å§‹åŠ è½½
                // ç¡®ä¿iframeä¹‹å‰æ²¡æœ‰srcï¼Œé¿å…æå‰åŠ è½½
                if (iframe) {
                    // å¦‚æœiframeè¿˜æ²¡æœ‰srcï¼Œæˆ–è€…srcæ˜¯ç©ºçš„ï¼Œæ‰è®¾ç½®æ–°çš„URL
                    if (!iframe.src || iframe.src === '' || iframe.src === 'about:blank') {
                        updateIframeUrl();
                    } else {
                        // å¦‚æœå·²ç»æœ‰srcï¼Œæ›´æ–°ä¸ºæ–°çš„URLï¼ˆåˆ‡æ¢çº¿è·¯æ—¶ï¼‰
                        updateIframeUrl();
                    }
                }
                
                // æ›´æ–°é«˜åº¦
                setTimeout(updateIframeHeight, 100);
                setTimeout(updateIframeHeight, 500);
            }
            
            // ç›´æ¥åŠ è½½ä¿å­˜çš„çº¿è·¯ï¼ˆè·³è¿‡é€‰æ‹©ç•Œé¢ï¼‰
            function loadSavedRoute() {
                if (!selectedRoute) return false;
                
                iframeBaseUrl = selectedRoute.url;
                
                // æ›´æ–°æ‰€æœ‰é“¾æ¥
                updateAllLinks();
                
                // æ˜¾ç¤ºiframeå®¹å™¨
                if (iframeWrapper) {
                    iframeWrapper.style.display = '';
                }
                
                // æ˜¾ç¤ºé‡æ–°é€‰æ‹©çº¿è·¯æŒ‰é’®
                if (routeChangeBtn) {
                    routeChangeBtn.style.display = 'flex';
                }
                
                // è®¾ç½®iframeçš„srcå¹¶å¼€å§‹åŠ è½½
                if (iframe) {
                    updateIframeUrl();
                }
                
                // æ›´æ–°é«˜åº¦
                setTimeout(updateIframeHeight, 100);
                setTimeout(updateIframeHeight, 500);
                
                return true;
            }
            
            // æ›´æ–°iframeçš„srcå’Œæ‰€æœ‰ç›¸å…³é“¾æ¥
            function updateIframeUrl() {
                const newUrl = buildIframeUrl(getCurrentUrl());
                if (iframe && newUrl) {
                    if (iframe.src !== newUrl) {
                        iframe.src = newUrl;
                        hasLoaded = false; // é‡ç½®åŠ è½½çŠ¶æ€
                        if (loading) {
                            loading.classList.remove('hidden');
                        }
                    } else {
                        // å³ä½¿URLç›¸åŒï¼Œä¹Ÿç¡®ä¿å‚æ•°å­˜åœ¨
                        const param = getQueryParam() || getCurrentHash();
                        if (param && !iframe.src.includes(param)) {
                            iframe.src = newUrl;
                        }
                    }
                }
                
                // æ›´æ–°æ‰€æœ‰é“¾æ¥çš„URL
                updateAllLinks();
            }
            
            // æ£€æµ‹æ··åˆå†…å®¹é—®é¢˜
            function checkMixedContent() {
                return window.location.protocol === 'https:' && iframe && iframe.src.startsWith('http:');
            }
            
            // æ˜¾ç¤ºæ··åˆå†…å®¹è­¦å‘Š
            function showMixedContentWarning() {
                if (mixedContentWarning) {
                    mixedContentWarning.style.display = 'block';
                    // æ›´æ–°è­¦å‘Šä¸­çš„é“¾æ¥URL
                    updateAllLinks();
                }
                if (iframeWrapper) {
                    iframeWrapper.style.display = 'none';
                }
                if (loading) {
                    loading.classList.add('hidden');
                }
                errorDetected = true;
            }
            
            // æ£€æµ‹iframeæ˜¯å¦æˆåŠŸåŠ è½½
            function checkIframeLoad() {
                checkCount++;
                try {
                    // å°è¯•è®¿é—®iframeå†…å®¹ï¼ˆå¯èƒ½å› è·¨åŸŸå¤±è´¥ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (iframeDoc && iframeDoc.readyState === 'complete') {
                        hideLoading();
                        hasLoaded = true;
                        return true;
                    }
                } catch (e) {
                    // è·¨åŸŸè®¿é—®è¢«é˜»æ­¢æ˜¯æ­£å¸¸çš„ï¼Œä¸ä»£è¡¨åŠ è½½å¤±è´¥
                    // å¦‚æœiframeå·²ç»åŠ è½½äº†ä¸€æ®µæ—¶é—´ï¼Œè®¤ä¸ºåŠ è½½æˆåŠŸ
                    if (!errorDetected && checkCount > 3) {
                        // å»¶è¿Ÿéšè—åŠ è½½æç¤ºï¼Œç»™iframeæ›´å¤šæ—¶é—´
                        setTimeout(hideLoading, 1000);
                        return true;
                    }
                }
                return false;
            }
            
            // éšè—åŠ è½½æç¤º
            function hideLoading() {
                if (loading && !hasLoaded) {
                    loading.classList.add('hidden');
                    hasLoaded = true;
                    if (loadTimeout) {
                        clearTimeout(loadTimeout);
                    }
                }
            }
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            function showError(message, details) {
                errorDetected = true;
                if (loading) {
                    let errorHTML = '<div class="error-message">' + message + '</div>';
                    if (details) {
                        errorHTML += '<div style="font-size: 12px; color: #999; margin-top: 10px;">' + details + '</div>';
                    }
                    const param = getQueryParam() || getCurrentHash();
                    const errorUrl = buildIframeUrl(getCurrentUrl());
                    errorHTML += '<a href="' + errorUrl + '" target="_blank" rel="noopener noreferrer" class="error-link">ç‚¹å‡»è¿™é‡Œåœ¨æ–°çª—å£ä¸­æ‰“å¼€</a>';
                    loading.innerHTML = errorHTML;
                    loading.classList.remove('hidden');
                }
            }
            
            // æµ‹è¯•URLæ˜¯å¦å¯è®¿é—®
            function testUrlAccessibility() {
                return new Promise(function(resolve) {
                    const testUrl = getCurrentUrl();
                    if (!testUrl) {
                        resolve(false);
                        return;
                    }
                    
                    const testImg = new Image();
                    testImg.onload = function() {
                        resolve(true);
                    };
                    testImg.onerror = function() {
                        resolve(false);
                    };
                    // å°è¯•åŠ è½½ç›®æ ‡URLçš„faviconæˆ–æ ¹è·¯å¾„
                    testImg.src = testUrl + '/favicon.ico?' + Date.now();
                    setTimeout(function() {
                        resolve(null); // è¶…æ—¶è¿”å›null
                    }, 3000);
                });
            }
            
            // iframeåŠ è½½äº‹ä»¶å¤„ç†
            // æ³¨æ„ï¼šä¸åœ¨é¡µé¢åŠ è½½æ—¶ç«‹å³è®¾ç½®iframeçš„srcï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©çº¿è·¯åå†åŠ è½½
            if (iframe) {
                // ç›‘å¬hashå˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°iframe URLï¼ˆä»…åœ¨å·²é€‰æ‹©çº¿è·¯åï¼‰
                window.addEventListener('hashchange', function() {
                    // åªæœ‰åœ¨å·²ç»é€‰æ‹©äº†çº¿è·¯çš„æƒ…å†µä¸‹æ‰æ›´æ–°
                    if (selectedRoute && iframe.src) {
                        updateIframeUrl();
                    }
                });
                
                // ç«‹å³æ£€æŸ¥æ··åˆå†…å®¹é—®é¢˜
                const hasMixedContent = checkMixedContent();
                if (hasMixedContent) {
                    console.warn('æ£€æµ‹åˆ°æ··åˆå†…å®¹é—®é¢˜ï¼šHTTPSé¡µé¢æ— æ³•åµŒå…¥HTTPå†…å®¹');
                    // ç«‹å³æ˜¾ç¤ºè­¦å‘Šï¼Œä¸ç­‰å¾…iframeåŠ è½½
                    showMixedContentWarning();
                    return; // æå‰è¿”å›ï¼Œä¸ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
                }
                
                // ç›‘å¬iframeåŠ è½½å®Œæˆ
                iframe.addEventListener('load', function() {
                    console.log('iframe load äº‹ä»¶è§¦å‘');
                    const isWeChat = /micromessenger/i.test(navigator.userAgent);
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                                 (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                    
                    // æ›´æ–°é«˜åº¦ï¼Œç¡®ä¿å†…å®¹å®Œæ•´æ˜¾ç¤º
                    updateIframeHeight();
                    
                    // å»¶è¿Ÿä¸€ç‚¹å†éšè—ï¼Œç¡®ä¿å†…å®¹æ¸²æŸ“å®Œæˆ
                    setTimeout(function() {
                        if (!errorDetected) {
                            hideLoading();
                            // å†æ¬¡æ›´æ–°é«˜åº¦ï¼Œç¡®ä¿åº•éƒ¨å¯¼èˆªæ å¯è§
                            updateIframeHeight();
                        }
                    }, 800);
                    
                    // å»¶è¿Ÿæ›´æ–°é«˜åº¦ï¼Œç­‰å¾…å†…å®¹å®Œå…¨æ¸²æŸ“
                    setTimeout(updateIframeHeight, 1500);
                    setTimeout(updateIframeHeight, 3000);
                    
                    // å¾®ä¿¡å’ŒiOSéœ€è¦æ›´å¤šæ¬¡æ›´æ–°
                    if (isWeChat || isIOS) {
                        setTimeout(updateIframeHeight, 500);
                        setTimeout(updateIframeHeight, 1000);
                        setTimeout(updateIframeHeight, 2000);
                        setTimeout(updateIframeHeight, 4000);
                    }
                });
                
                // ç›‘å¬iframeåŠ è½½é”™è¯¯
                iframe.addEventListener('error', function(e) {
                    console.error('iframe error äº‹ä»¶è§¦å‘', e);
                    // å†æ¬¡æ£€æŸ¥æ˜¯å¦æ˜¯æ··åˆå†…å®¹é—®é¢˜
                    if (checkMixedContent()) {
                        showMixedContentWarning();
                        return;
                    }
                    
                    let errorMsg = 'åŠ è½½å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š';
                    let details = '';
                    errorMsg += '<br>â€¢ ç›®æ ‡ç½‘ç«™ä¸å…è®¸åµŒå…¥ï¼ˆX-Frame-Optionsé™åˆ¶ï¼‰';
                    errorMsg += '<br>â€¢ ç½‘ç»œè¿æ¥é—®é¢˜';
                    errorMsg += '<br>â€¢ æœåŠ¡å™¨æœªå“åº”';
                    details += 'æç¤ºï¼šè¯·æ£€æŸ¥ç›®æ ‡URLæ˜¯å¦å¯è®¿é—®ï¼Œæˆ–å°è¯•åœ¨æ–°çª—å£ä¸­æ‰“å¼€ã€‚';
                    
                    showError(errorMsg, details);
                });
                
                // ä½¿ç”¨å¤šç§æ–¹å¼æ£€æµ‹åŠ è½½çŠ¶æ€
                let loadCheckInterval = setInterval(function() {
                    // å¦‚æœæ£€æµ‹åˆ°æ··åˆå†…å®¹ï¼Œåœæ­¢æ£€æŸ¥
                    if (checkMixedContent() && !errorDetected) {
                        clearInterval(loadCheckInterval);
                        showMixedContentWarning();
                        return;
                    }
                    
                    if (hasLoaded) {
                        clearInterval(loadCheckInterval);
                        return;
                    }
                    
                    if (checkIframeLoad()) {
                        clearInterval(loadCheckInterval);
                    } else if (checkCount >= maxChecks) {
                        clearInterval(loadCheckInterval);
                        // å¦‚æœæ£€æŸ¥äº†è¶³å¤Ÿå¤šæ¬¡è¿˜æ²¡æˆåŠŸï¼Œå†æ¬¡æ£€æŸ¥æ··åˆå†…å®¹
                        if (checkMixedContent()) {
                            showMixedContentWarning();
                            return;
                        }
                        // å°è¯•æµ‹è¯•URLå¯è®¿é—®æ€§
                        testUrlAccessibility().then(function(accessible) {
                            if (accessible === false) {
                                showError('æ— æ³•è¿æ¥åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚', 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–URLæ˜¯å¦æ­£ç¡®ã€‚');
                            } else if (!hasLoaded) {
                                // å³ä½¿æ— æ³•ç¡®å®šï¼Œä¹Ÿéšè—åŠ è½½æç¤ºï¼Œè®©ç”¨æˆ·çœ‹åˆ°iframe
                                hideLoading();
                            }
                        });
                    }
                }, 500);
                
                // å¤‡ç”¨æ£€æµ‹ï¼šå¦‚æœ8ç§’åè¿˜æ²¡åŠ è½½å®Œæˆï¼Œéšè—åŠ è½½æç¤º
                loadTimeout = setTimeout(function() {
                    if (!hasLoaded && !errorDetected) {
                        console.log('è¶…æ—¶éšè—åŠ è½½æç¤º');
                        hideLoading();
                    }
                }, 8000);
                
                // 15ç§’ååœæ­¢æ‰€æœ‰æ£€æŸ¥
                setTimeout(function() {
                    clearInterval(loadCheckInterval);
                    if (loadTimeout) {
                        clearTimeout(loadTimeout);
                    }
                }, 15000);
            }
            
            // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && iframe && !hasLoaded && !errorDetected) {
                    checkIframeLoad();
                }
            });
            
            // è®¡ç®—å®é™…å¯ç”¨é«˜åº¦ï¼ˆè€ƒè™‘ç§»åŠ¨ç«¯æµè§ˆå™¨å·¥å…·æ ï¼‰
            function getAvailableHeight() {
                // æ£€æµ‹æ˜¯å¦ä¸ºå¾®ä¿¡æµè§ˆå™¨
                const isWeChat = /micromessenger/i.test(navigator.userAgent);
                // æ£€æµ‹æ˜¯å¦ä¸ºiOSè®¾å¤‡
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                
                // å¾®ä¿¡æµè§ˆå™¨å’ŒiOSçš„ç‰¹æ®Šå¤„ç†
                if (isWeChat || isIOS) {
                    // ä¼˜å…ˆä½¿ç”¨visualViewportï¼ˆå¦‚æœæ”¯æŒï¼‰
                    if (window.visualViewport && window.visualViewport.height) {
                        return window.visualViewport.height;
                    }
                    // iOS Safariçš„ç‰¹æ®Šå¤„ç†ï¼šä½¿ç”¨screen.heightä½œä¸ºå‚è€ƒ
                    if (isIOS && window.screen && window.screen.height) {
                        // å°è¯•å¤šç§æ–¹å¼è·å–å‡†ç¡®é«˜åº¦
                        const innerHeight = window.innerHeight || 0;
                        const screenHeight = window.screen.height;
                        const clientHeight = document.documentElement.clientHeight || 0;
                        
                        // é€‰æ‹©æœ€å¤§çš„æœ‰æ•ˆé«˜åº¦å€¼
                        let height = Math.max(innerHeight, clientHeight);
                        
                        // å¦‚æœé«˜åº¦å¼‚å¸¸å°ï¼ˆå¯èƒ½æ˜¯å·¥å…·æ å½±å“ï¼‰ï¼Œä½¿ç”¨screen.height
                        if (height < screenHeight * 0.5) {
                            height = screenHeight;
                        }
                        
                        // ç¡®ä¿é«˜åº¦åˆç†ï¼ˆä¸è¶…è¿‡å±å¹•é«˜åº¦ï¼‰
                        if (height > screenHeight) {
                            height = screenHeight;
                        }
                        
                        return height;
                    }
                }
                
                // ä¼˜å…ˆä½¿ç”¨åŠ¨æ€è§†å£é«˜åº¦ï¼ˆè€ƒè™‘ç§»åŠ¨ç«¯æµè§ˆå™¨å·¥å…·æ ï¼‰
                if (window.visualViewport && window.visualViewport.height) {
                    return window.visualViewport.height;
                }
                
                // ä½¿ç”¨æ ‡å‡†è§†å£é«˜åº¦
                const height = window.innerHeight || document.documentElement.clientHeight;
                return height || window.screen.height || 800; // é»˜è®¤å€¼
            }
            
            // æ›´æ–°iframeé«˜åº¦
            function updateIframeHeight() {
                if (iframe && iframeWrapper) {
                    let availableHeight = getAvailableHeight();
                    const isWeChat = /micromessenger/i.test(navigator.userAgent);
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                                 (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                    
                    // å¦‚æœé”®ç›˜å¼¹èµ·ï¼Œä½¿ç”¨visualViewportçš„é«˜åº¦
                    if (window.keyboardVisible && window.visualViewport && window.visualViewport.height) {
                        availableHeight = window.visualViewport.height;
                    }
                    
                    // ç¡®ä¿iframeä½¿ç”¨å®Œæ•´çš„å¯ç”¨é«˜åº¦
                    iframeWrapper.style.height = availableHeight + 'px';
                    iframeWrapper.style.minHeight = availableHeight + 'px';
                    iframeWrapper.style.maxHeight = availableHeight + 'px';
                    
                    // iframeé«˜åº¦è®¾ç½®
                    iframe.style.height = availableHeight + 'px';
                    iframe.style.minHeight = availableHeight + 'px';
                    iframe.style.maxHeight = 'none'; // å…è®¸å†…å®¹è¶…å‡ºæ—¶æ»šåŠ¨
                    iframe.style.width = '100%';
                    
                    // ç¡®ä¿iframeå®šä½å‡†ç¡®ï¼Œä½¿ç”¨absoluteå®šä½ï¼ˆæ‰€æœ‰è®¾å¤‡ï¼‰
                    iframe.style.position = 'absolute';
                    iframe.style.top = '0';
                    iframe.style.left = '0';
                    iframe.style.right = '0';
                    iframe.style.bottom = '0';
                    iframe.style.display = 'block';
                    
                    // ç¡®ä¿æ»šåŠ¨ç›¸å…³æ ·å¼ä¸è¢«è¦†ç›–ï¼Œé˜²æ­¢æ¨ªå‘æ»šåŠ¨
                    iframe.style.overflow = 'auto';
                    iframe.style.overflowX = 'hidden';
                    iframe.style.overflowY = 'auto';
                    iframe.style.webkitOverflowScrolling = 'touch';
                    iframe.style.maxWidth = '100%';
                    // é˜²æ­¢å†…å®¹æº¢å‡º
                    iframe.style.boxSizing = 'border-box';
                    
                    // é”®ç›˜å¼¹èµ·æ—¶ï¼Œç¡®ä¿iframeå¯ä»¥æ»šåŠ¨ï¼Œè®©è¾“å…¥æ¡†å¯è§
                    if (window.keyboardVisible) {
                        iframe.style.overflowY = 'auto';
                        iframe.style.webkitOverflowScrolling = 'touch';
                    }
                    
                    // ç¡®ä¿ç‚¹å‡»ä½ç½®å‡†ç¡® - ç§»é™¤æ‰€æœ‰å¯èƒ½å½±å“å®šä½çš„æ ·å¼
                    iframe.style.pointerEvents = 'auto';
                    iframe.style.touchAction = 'manipulation'; // Chromeæ¨¡æ‹Ÿå™¨ä¼˜åŒ–
                    iframe.style.transform = 'none';
                    iframe.style.willChange = 'auto';
                    iframe.style.zoom = '1';
                    iframe.style.webkitTransform = 'none';
                    iframe.style.mozTransform = 'none';
                    iframe.style.msTransform = 'none';
                    iframe.style.oTransform = 'none';
                    iframe.style.margin = '0';
                    iframe.style.padding = '0';
                    // Chromeæ¨¡æ‹Ÿå™¨ä¼˜åŒ– - ç¡®ä¿åæ ‡å‡†ç¡®
                    iframe.style.webkitTapHighlightColor = 'transparent';
                    iframe.style.webkitTouchCallout = 'none';
                    
                    // ç¡®ä¿iframeå®¹å™¨å®šä½å‡†ç¡®
                    iframeWrapper.style.overflow = 'hidden';
                    iframeWrapper.style.transform = 'none';
                    iframeWrapper.style.willChange = 'auto';
                    
                    const iframeContainer = document.querySelector('.iframe-container');
                    if (iframeContainer) {
                        iframeContainer.style.overflow = 'hidden';
                        iframeContainer.style.overflowX = 'hidden';
                        iframeContainer.style.height = availableHeight + 'px';
                        iframeContainer.style.minHeight = availableHeight + 'px';
                        iframeContainer.style.maxHeight = availableHeight + 'px';
                        iframeContainer.style.position = 'relative';
                        iframeContainer.style.width = '100%';
                        iframeContainer.style.maxWidth = '100%';
                        iframeContainer.style.transform = 'none';
                        iframeContainer.style.willChange = 'auto';
                        iframeContainer.style.margin = '0';
                        iframeContainer.style.padding = '0';
                    }
                    
                    // å¾®ä¿¡å’ŒiOSç‰¹æ®Šå¤„ç†ï¼šç¡®ä¿å¯ä»¥æ»šåŠ¨
                    if (isWeChat || isIOS) {
                        // é¢å¤–çš„iOS/å¾®ä¿¡ä¼˜åŒ–
                        iframe.style.webkitOverflowScrolling = 'touch';
                    }
                    
                    // ç¡®ä¿å®¹å™¨ä¹Ÿä½¿ç”¨æ­£ç¡®çš„é«˜åº¦
                    const container = document.querySelector('.container');
                    if (container) {
                        container.style.height = availableHeight + 'px';
                        container.style.maxHeight = availableHeight + 'px';
                        container.style.minHeight = availableHeight + 'px';
                    }
                    
                    // å¼ºåˆ¶é‡ç»˜å’Œé‡æ–°è®¡ç®—å¸ƒå±€ï¼ˆç¡®ä¿ç‚¹å‡»ä½ç½®å‡†ç¡®ï¼‰
                    // Chromeæ¨¡æ‹Ÿå™¨å’Œæ‰€æœ‰è®¾å¤‡éƒ½éœ€è¦ç¡®ä¿å¸ƒå±€å‡†ç¡®
                    void iframe.offsetHeight;
                    if (iframeContainer) {
                        void iframeContainer.offsetHeight;
                    }
                    void iframeWrapper.offsetHeight;
                    
                    // ç¡®ä¿iframeçš„å°ºå¯¸å’Œä½ç½®å®Œå…¨åŒ¹é…å®¹å™¨ï¼ˆæ‰€æœ‰è®¾å¤‡ï¼Œç‰¹åˆ«æ˜¯Chromeæ¨¡æ‹Ÿå™¨ï¼‰
                    if (iframeContainer) {
                        const containerRect = iframeContainer.getBoundingClientRect();
                        if (containerRect) {
                            iframe.style.width = containerRect.width + 'px';
                            iframe.style.height = containerRect.height + 'px';
                            iframe.style.left = '0px';
                            iframe.style.top = '0px';
                        }
                    }
                }
            }
            
            // å¤„ç†çª—å£å¤§å°å˜åŒ–ï¼Œç¡®ä¿iframeæ­£ç¡®æ˜¾ç¤º
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    updateIframeHeight();
                }, 100);
            });
            
            // ç›‘å¬è§†è§‰è§†å£å˜åŒ–ï¼ˆç§»åŠ¨ç«¯æµè§ˆå™¨å·¥å…·æ æ˜¾ç¤º/éšè—æ—¶ï¼Œä»¥åŠé”®ç›˜å¼¹èµ·/æ”¶èµ·ï¼‰
            let lastVisualViewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
            let keyboardVisible = false;
            
            // å°†keyboardVisibleæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿updateIframeHeightå¯ä»¥è®¿é—®
            window.keyboardVisible = false;
            
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', function() {
                    const currentHeight = window.visualViewport.height;
                    const heightDiff = lastVisualViewportHeight - currentHeight;
                    
                    // æ£€æµ‹é”®ç›˜æ˜¯å¦å¼¹èµ·ï¼ˆé«˜åº¦æ˜æ˜¾å‡å°ï¼Œé€šå¸¸å‡å°‘è¶…è¿‡150pxï¼‰
                    if (heightDiff > 150) {
                        keyboardVisible = true;
                        window.keyboardVisible = true;
                        // é”®ç›˜å¼¹èµ·æ—¶ï¼Œä½¿ç”¨å½“å‰å¯è§†é«˜åº¦ï¼Œå¹¶é˜²æ­¢é¡µé¢æ»šåŠ¨
                        handleKeyboardShow();
                    } else if (heightDiff < -50) {
                        // é”®ç›˜æ”¶èµ·æ—¶
                        keyboardVisible = false;
                        window.keyboardVisible = false;
                        handleKeyboardHide();
                    }
                    
                    lastVisualViewportHeight = currentHeight;
                    updateIframeHeight();
                    // é˜²æ­¢è¾“å…¥æ¡†èšç„¦æ—¶è‡ªåŠ¨ç¼©æ”¾
                    preventAutoZoom();
                });
                
                window.visualViewport.addEventListener('scroll', function() {
                    // é”®ç›˜å¼¹èµ·æ—¶ï¼Œå…è®¸visualViewportæ»šåŠ¨ï¼Œè¿™æ ·è¾“å…¥æ¡†å¯ä»¥ä¿æŒåœ¨å¯è§†åŒºåŸŸ
                    // ä½†é˜²æ­¢å¤–å±‚é¡µé¢æ»šåŠ¨
                    if (keyboardVisible) {
                        // åªé˜²æ­¢å¤–å±‚é¡µé¢æ»šåŠ¨ï¼Œå…è®¸visualViewportæ»šåŠ¨
                        window.scrollTo(0, 0);
                    }
                    updateIframeHeight();
                });
            }
            
            // å¤„ç†é”®ç›˜å¼¹èµ·
            function handleKeyboardShow() {
                // é˜²æ­¢å¤–å±‚é¡µé¢æ»šåŠ¨ï¼Œä½†å…è®¸iframeå†…å®¹æ»šåŠ¨
                document.body.style.position = 'fixed';
                document.body.style.top = '0';
                document.body.style.left = '0';
                document.body.style.right = '0';
                document.body.style.bottom = '0';
                document.body.style.overflow = 'hidden';
                
                // ç«‹å³æ›´æ–°iframeé«˜åº¦ï¼Œä½¿å…¶é€‚åº”é”®ç›˜å¼¹èµ·åçš„å¯è§†åŒºåŸŸ
                updateIframeHeight();
                
                // å»¶è¿Ÿä¸€ä¸‹ï¼Œè®©iframeå†…å®¹æœ‰æœºä¼šè‡ªåŠ¨æ»šåŠ¨åˆ°è¾“å…¥æ¡†ä½ç½®
                setTimeout(function() {
                    // å°è¯•è®©iframeå†…å®¹æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆè¾“å…¥æ¡†é€šå¸¸åœ¨åº•éƒ¨ï¼‰
                    try {
                        if (iframe && iframe.contentWindow) {
                            // æ»šåŠ¨åˆ°iframeåº•éƒ¨ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
                            iframe.contentWindow.scrollTo({
                                top: iframe.contentDocument?.body?.scrollHeight || 999999,
                                behavior: 'smooth'
                            });
                        }
                    } catch (e) {
                        // è·¨åŸŸé™åˆ¶ï¼Œæ— æ³•è®¿é—®iframeå†…å®¹
                        console.log('æ— æ³•è®¿é—®iframeå†…å®¹ï¼ˆè·¨åŸŸé™åˆ¶ï¼‰');
                    }
                    
                    // æ›´æ–°iframeé«˜åº¦ï¼Œç¡®ä¿å¸ƒå±€æ­£ç¡®
                    updateIframeHeight();
                }, 300);
            }
            
            // å¤„ç†é”®ç›˜æ”¶èµ·
            function handleKeyboardHide() {
                // æ¢å¤é¡µé¢æ ·å¼
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.body.style.right = '';
                document.body.style.bottom = '';
                document.body.style.overflow = '';
                
                // æ›´æ–°iframeé«˜åº¦
                setTimeout(updateIframeHeight, 100);
                setTimeout(updateIframeHeight, 300);
            }
            
            // é˜²æ­¢è¾“å…¥æ¡†èšç„¦æ—¶é¡µé¢è‡ªåŠ¨ç¼©æ”¾ï¼ˆiOS Safarié—®é¢˜ï¼‰
            let lastViewportWidth = window.innerWidth;
            let lastViewportHeight = window.innerHeight;
            
            function preventAutoZoom() {
                // æ£€æµ‹è§†å£æ˜¯å¦å› ä¸ºè¾“å…¥æ¡†èšç„¦è€Œæ”¹å˜
                const currentWidth = window.innerWidth;
                const currentHeight = window.innerHeight;
                
                // å¦‚æœè§†å£å¤§å°çªç„¶æ”¹å˜ï¼ˆé€šå¸¸æ˜¯è‡ªåŠ¨ç¼©æ”¾å¯¼è‡´çš„ï¼‰ï¼Œå¼ºåˆ¶æ¢å¤
                if (Math.abs(currentWidth - lastViewportWidth) > 10 || 
                    Math.abs(currentHeight - lastViewportHeight) > 10) {
                    // å¼ºåˆ¶æ¢å¤è§†å£è®¾ç½®
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (viewport) {
                        viewport.setAttribute('content', 
                            'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, shrink-to-fit=no');
                    }
                    // æ›´æ–°iframeé«˜åº¦
                    updateIframeHeight();
                }
                
                lastViewportWidth = currentWidth;
                lastViewportHeight = currentHeight;
            }
            
            // å®šæœŸæ£€æŸ¥è§†å£å¤§å°ï¼ˆé˜²æ­¢è‡ªåŠ¨ç¼©æ”¾ï¼‰
            setInterval(preventAutoZoom, 500);
            
            // å¾®ä¿¡æµè§ˆå™¨ç‰¹æ®Šå¤„ç†ï¼šç›‘å¬orientationchangeï¼ˆå±å¹•æ—‹è½¬ï¼‰
            if (isWeChat) {
                window.addEventListener('orientationchange', function() {
                    setTimeout(updateIframeHeight, 300);
                    setTimeout(updateIframeHeight, 600);
                });
                
                // å¾®ä¿¡æµè§ˆå™¨å¯èƒ½éœ€è¦æ›´é¢‘ç¹çš„é«˜åº¦æ›´æ–°
                let wechatHeightCheck = setInterval(function() {
                    updateIframeHeight();
                }, 2000);
                
                // 10ç§’ååœæ­¢é¢‘ç¹æ£€æŸ¥
                setTimeout(function() {
                    if (wechatHeightCheck) {
                        clearInterval(wechatHeightCheck);
                    }
                }, 10000);
            }
            
            // é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°é«˜åº¦
            window.addEventListener('load', function() {
                updateIframeHeight();
                // å»¶è¿Ÿå†æ¬¡æ›´æ–°ï¼Œç¡®ä¿æµè§ˆå™¨å·¥å…·æ å·²å®Œå…¨æ˜¾ç¤º/éšè—
                setTimeout(updateIframeHeight, 300);
                setTimeout(updateIframeHeight, 600);
                setTimeout(updateIframeHeight, 1000);
                // å¾®ä¿¡æµè§ˆå™¨éœ€è¦æ›´å¤šæ¬¡æ›´æ–°
                if (isWeChat) {
                    setTimeout(updateIframeHeight, 1500);
                    setTimeout(updateIframeHeight, 2000);
                }
            });
            
            // åˆå§‹é«˜åº¦è®¾ç½®
            updateIframeHeight();
            
            // DOMContentLoadedæ—¶ä¹Ÿæ›´æ–°ä¸€æ¬¡
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    updateIframeHeight();
                });
            } else {
                updateIframeHeight();
            }
            
            // æ£€æµ‹æ˜¯å¦æ”¯æŒiframe
            if (!iframe) {
                showError('æµè§ˆå™¨ä¸æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚');
            }
            
            // åˆå§‹åŒ–æ‰€æœ‰é“¾æ¥ï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶ï¼‰
            function initializeLinks() {
                updateAllLinks();
            }
            
            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é“¾æ¥
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeLinks);
            } else {
                initializeLinks();
            }
            
            // å®‰å…¨æ£€æµ‹åŠ¨ç”»
            function startSecurityCheck() {
                const securityCheckContent = document.getElementById('securityCheckContent');
                const checkSubtitle = document.getElementById('checkSubtitle');
                const progressFill = document.getElementById('progressFill');
                
                // ç¡®ä¿å¿…è¦çš„DOMå…ƒç´ å­˜åœ¨
                if (!securityCheckContent) {
                    console.warn('å®‰å…¨æ£€æµ‹å†…å®¹å…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿé‡è¯•');
                    setTimeout(startSecurityCheck, 200);
                    return;
                }
                
                // æ£€æµ‹æ˜¯å¦ä¸ºiOSè®¾å¤‡
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
                
                // iOSè®¾å¤‡ä½¿ç”¨æ›´çŸ­çš„å»¶è¿Ÿæ—¶é—´
                const baseDelay = isIOS ? 200 : 300;
                const steps = [
                    { id: 'step1', text: 'æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ', delay: baseDelay },
                    { id: 'step2', text: 'éªŒè¯å®‰å…¨è¿æ¥', delay: baseDelay * 2 },
                    { id: 'step3', text: 'æ£€æŸ¥è®¿é—®æƒé™', delay: baseDelay * 3 },
                    { id: 'step4', text: 'å®Œæˆå®‰å…¨éªŒè¯', delay: baseDelay * 4 }
                ];
                
                let currentStep = 0;
                let isCompleted = false;
                let stepTimeouts = [];
                let startTime = Date.now();
                
                // å¼ºåˆ¶å®Œæˆå‡½æ•°ï¼ˆè¶…æ—¶ä¿æŠ¤ï¼‰
                function forceComplete() {
                    if (isCompleted) return;
                    isCompleted = true;
                    
                    // æ¸…ç†æ‰€æœ‰æœªæ‰§è¡Œçš„setTimeout
                    stepTimeouts.forEach(function(timeoutId) {
                        if (timeoutId) clearTimeout(timeoutId);
                    });
                    stepTimeouts = [];
                    
                    // æ ‡è®°æ‰€æœ‰æ­¥éª¤ä¸ºå®Œæˆ
                    steps.forEach(function(s) {
                        try {
                            const el = document.getElementById(s.id);
                            if (el) {
                                el.classList.remove('active');
                                el.classList.add('completed');
                            }
                        } catch (e) {
                            // å¿½ç•¥é”™è¯¯
                        }
                    });
                    
                    // æ›´æ–°å›¾æ ‡å’Œæ ‡é¢˜
                    try {
                        const securityIcon = document.querySelector('.security-icon');
                        if (securityIcon) {
                            securityIcon.textContent = 'âœ“';
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                    }
                    
                    // æ›´æ–°ä¸»æ ‡é¢˜
                    try {
                        const mainTitle = securityCheckContent.querySelector('h2');
                        if (mainTitle) {
                            mainTitle.textContent = 'å®‰å…¨éªŒè¯';
                            mainTitle.style.opacity = '1';
                            mainTitle.style.transform = 'translateY(0)';
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                    }
                    
                    try {
                        if (checkSubtitle) {
                            checkSubtitle.style.display = 'none';
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                    }
                    
                    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                    try {
                        if (securityCheckContent) {
                            securityCheckContent.classList.add('check-complete');
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                    }
                    
                    // ç¡®ä¿è¿›åº¦æ¡100%
                    try {
                        if (progressFill) {
                            progressFill.style.width = '100%';
                        }
                    } catch (e) {
                        // å¿½ç•¥é”™è¯¯
                    }
                    
                    // æ£€æµ‹å®Œæˆåè‡ªåŠ¨è¿›å…¥çº¿è·¯é€‰æ‹©ç•Œé¢ï¼ˆå»¶è¿Ÿä¸€ç‚¹æ˜¾ç¤ºå®Œæˆæ•ˆæœï¼‰
                    setTimeout(function() {
                        hideSecurityCheck();
                    }, 800);
                }
                
                // è®¾ç½®æ€»è¶…æ—¶ä¿æŠ¤
                const totalTimeoutDuration = isIOS ? 2500 : 3000;
                const totalTimeout = setTimeout(function() {
                    forceComplete();
                }, totalTimeoutDuration);
                stepTimeouts.push(totalTimeout);
                
                // æ·»åŠ é¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœ2ç§’åè¿˜æ²¡å®Œæˆï¼Œå¼ºåˆ¶å®Œæˆ
                const quickTimeout = setTimeout(function() {
                    if (!isCompleted && currentStep < steps.length - 1) {
                        currentStep = steps.length;
                        forceComplete();
                    }
                }, 2000);
                stepTimeouts.push(quickTimeout);
                
                function showNextStep() {
                    if (isCompleted) return;
                    
                    const elapsed = Date.now() - startTime;
                    if (elapsed > 3000) {
                        forceComplete();
                        return;
                    }
                    
                    if (currentStep < steps.length) {
                        const step = steps[currentStep];
                        
                        try {
                            const stepElement = document.getElementById(step.id);
                            if (stepElement) {
                                stepElement.classList.add('active');
                            }
                        } catch (e) {
                            // å¿½ç•¥é”™è¯¯
                        }
                        
                        try {
                            const progress = ((currentStep + 1) / steps.length) * 100;
                            if (progressFill) {
                                progressFill.style.width = progress + '%';
                            }
                        } catch (e) {
                            // å¿½ç•¥é”™è¯¯
                        }
                        
                        try {
                            if (checkSubtitle) {
                                checkSubtitle.textContent = step.text + '...';
                            }
                        } catch (e) {
                            // å¿½ç•¥é”™è¯¯
                        }
                        
                        currentStep++;
                        
                        if (currentStep < steps.length) {
                            const nextDelay = isIOS ? Math.min(step.delay, 400) : step.delay;
                            try {
                                const timeoutId = setTimeout(function() {
                                    showNextStep();
                                }, nextDelay);
                                stepTimeouts.push(timeoutId);
                            } catch (e) {
                                setTimeout(function() {
                                    showNextStep();
                                }, 100);
                            }
                        } else {
                            forceComplete();
                        }
                    } else {
                        forceComplete();
                    }
                }
                
                function startCheck() {
                    try {
                        const firstStep = document.getElementById('step1');
                        if (firstStep && securityCheckContent) {
                            showNextStep();
                        } else {
                            forceComplete();
                        }
                    } catch (e) {
                        forceComplete();
                    }
                }
                
                const startDelay = isIOS ? 100 : 200;
                try {
                    const startTimeoutId = setTimeout(startCheck, startDelay);
                    stepTimeouts.push(startTimeoutId);
                } catch (e) {
                    if (window.requestAnimationFrame) {
                        let frameCount = 0;
                        const maxFrames = Math.ceil(startDelay / 16);
                        function rafStart() {
                            frameCount++;
                            if (frameCount >= maxFrames) {
                                startCheck();
                            } else {
                                requestAnimationFrame(rafStart);
                            }
                        }
                        requestAnimationFrame(rafStart);
                    } else {
                        startCheck();
                    }
                }
                
                const backupStart = setTimeout(function() {
                    if (currentStep === 0 && !isCompleted) {
                        forceComplete();
                    }
                }, 1000);
                stepTimeouts.push(backupStart);
            }
            
            // å®‰å…¨æ£€æµ‹é¡µé¢å¤„ç†
            function hideSecurityCheck() {
                if (securityCheck) {
                    securityCheck.classList.add('hidden');
                    setTimeout(function() {
                        if (securityCheck) {
                            securityCheck.style.display = 'none';
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„çº¿è·¯ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥åŠ è½½ï¼Œå¦åˆ™æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                        if (hasSavedRoute && selectedRoute) {
                            // ç›´æ¥åŠ è½½ä¿å­˜çš„çº¿è·¯ï¼Œè·³è¿‡é€‰æ‹©ç•Œé¢
                            loadSavedRoute();
                        } else {
                            // æ˜¾ç¤ºçº¿è·¯é€‰æ‹©ç•Œé¢
                            showRouteSelector();
                        }
                    }, 500);
                }
            }
            
            // çº¿è·¯é€‰æ‹©ç•Œé¢ï¼šç‚¹å‡»çº¿è·¯ç›´æ¥è¿›å…¥ï¼ˆå·²ç§»é™¤æŒ‰é’®ï¼‰
            
            // é‡é€‰çº¿è·¯æŒ‰é’®äº‹ä»¶ï¼ˆæ”¯æŒæ‹–åŠ¨å’Œå±•å¼€/æŠ˜å ï¼‰
            if (routeChangeBtn) {
                let isDragging = false;
                let dragStartX = 0;
                let dragStartY = 0;
                let initialX = 0;
                let initialY = 0;
                let currentX = 0;
                let currentY = 0;
                let isExpanded = false;
                let rafId = null;
                let btnWidth = 0;
                let btnHeight = 0;
                
                // ä»localStorageæ¢å¤æŒ‰é’®ä½ç½®å’ŒçŠ¶æ€
                const savedPosition = localStorage.getItem('routeChangeBtnPosition');
                if (savedPosition) {
                    try {
                        const pos = JSON.parse(savedPosition);
                        if (pos.top) routeChangeBtn.style.top = pos.top;
                        if (pos.right) routeChangeBtn.style.right = pos.right;
                        if (pos.left) routeChangeBtn.style.left = pos.left;
                        if (pos.bottom) routeChangeBtn.style.bottom = pos.bottom;
                    } catch (e) {
                        console.error('Failed to restore button position:', e);
                    }
                }
                
                // å±•å¼€æŒ‰é’®
                function expandButton() {
                    routeChangeBtn.classList.remove('collapsed');
                    routeChangeBtn.classList.add('expanded');
                    isExpanded = true;
                }
                
                // æŠ˜å æŒ‰é’®
                function collapseButton() {
                    routeChangeBtn.classList.remove('expanded');
                    routeChangeBtn.classList.add('collapsed');
                    isExpanded = false;
                }
                
                // åˆ‡æ¢å±•å¼€/æŠ˜å çŠ¶æ€
                function toggleExpand() {
                    if (isExpanded) {
                        collapseButton();
                    } else {
                        expandButton();
                    }
                }
                
                // é¼ æ ‡/è§¦æ‘¸å¼€å§‹æ‹–åŠ¨
                function startDrag(e) {
                    isDragging = false;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    dragStartX = clientX;
                    dragStartY = clientY;
                    
                    const rect = routeChangeBtn.getBoundingClientRect();
                    initialX = rect.left;
                    initialY = rect.top;
                    
                    // ç¼“å­˜æŒ‰é’®å°ºå¯¸ï¼Œé¿å…æ‹–åŠ¨æ—¶é‡å¤è®¡ç®—
                    btnWidth = routeChangeBtn.offsetWidth;
                    btnHeight = routeChangeBtn.offsetHeight;
                    
                    // å¦‚æœæŒ‰é’®æ˜¯æŠ˜å çŠ¶æ€ï¼Œå…ˆå±•å¼€
                    if (!isExpanded) {
                        expandButton();
                        // å±•å¼€åä¸æ‰§è¡Œæ‹–åŠ¨ï¼Œç­‰å¾…ä¸‹æ¬¡æ“ä½œ
                        e.preventDefault();
                        return;
                    }
                    
                    // æ‹–åŠ¨æ—¶ç¦ç”¨transition
                    routeChangeBtn.style.transition = 'none';
                    routeChangeBtn.classList.add('dragging');
                    e.preventDefault();
                }
                
                // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ‹–åŠ¨æ€§èƒ½
                function updatePosition() {
                    if (!routeChangeBtn.classList.contains('dragging')) {
                        rafId = null;
                        return;
                    }
                    
                    // é™åˆ¶åœ¨è§†å£å†…
                    const maxX = window.innerWidth - btnWidth;
                    const maxY = window.innerHeight - btnHeight;
                    
                    currentX = Math.max(0, Math.min(currentX, maxX));
                    currentY = Math.max(0, Math.min(currentY, maxY));
                    
                    // ç›´æ¥ä½¿ç”¨left/topå®šä½ï¼Œæ›´å‡†ç¡®
                    routeChangeBtn.style.left = currentX + 'px';
                    routeChangeBtn.style.top = currentY + 'px';
                    routeChangeBtn.style.right = 'auto';
                    routeChangeBtn.style.bottom = 'auto';
                    
                    rafId = null;
                }
                
                // æ‹–åŠ¨ä¸­
                function drag(e) {
                    if (!routeChangeBtn.classList.contains('dragging')) return;
                    
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    const deltaX = clientX - dragStartX;
                    const deltaY = clientY - dragStartY;
                    
                    // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡5pxï¼Œè®¤ä¸ºæ˜¯æ‹–åŠ¨è€Œä¸æ˜¯ç‚¹å‡»
                    if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                        isDragging = true;
                    }
                    
                    if (isDragging) {
                        currentX = initialX + deltaX;
                        currentY = initialY + deltaY;
                        
                        // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
                        if (!rafId) {
                            rafId = requestAnimationFrame(updatePosition);
                        }
                    }
                    
                    e.preventDefault();
                }
                
                // ç»“æŸæ‹–åŠ¨
                function endDrag(e) {
                    if (routeChangeBtn.classList.contains('dragging')) {
                        // å–æ¶ˆæœªå®Œæˆçš„åŠ¨ç”»å¸§
                        if (rafId) {
                            cancelAnimationFrame(rafId);
                            rafId = null;
                        }
                        
                        // åº”ç”¨æœ€ç»ˆä½ç½®ï¼ˆç§»é™¤transformï¼Œä½¿ç”¨left/topï¼‰
                        if (isDragging) {
                            const maxX = window.innerWidth - btnWidth;
                            const maxY = window.innerHeight - btnHeight;
                            currentX = Math.max(0, Math.min(currentX, maxX));
                            currentY = Math.max(0, Math.min(currentY, maxY));
                            
                            routeChangeBtn.style.transform = 'none';
                            routeChangeBtn.style.left = currentX + 'px';
                            routeChangeBtn.style.top = currentY + 'px';
                            routeChangeBtn.style.right = 'auto';
                            routeChangeBtn.style.bottom = 'auto';
                        }
                        
                        // æ¢å¤transition
                        routeChangeBtn.style.transition = '';
                        routeChangeBtn.classList.remove('dragging');
                        
                        // ä¿å­˜ä½ç½®åˆ°localStorage
                        const position = {
                            top: routeChangeBtn.style.top,
                            left: routeChangeBtn.style.left,
                            right: routeChangeBtn.style.right,
                            bottom: routeChangeBtn.style.bottom
                        };
                        localStorage.setItem('routeChangeBtnPosition', JSON.stringify(position));
                        
                        // å¦‚æœä¸æ˜¯æ‹–åŠ¨ï¼Œè€Œæ˜¯ç‚¹å‡»ï¼Œåˆ™æ‰§è¡Œç‚¹å‡»äº‹ä»¶
                        if (!isDragging && isExpanded) {
                            // éšè—iframeï¼Œæ˜¾ç¤ºçº¿è·¯é€‰æ‹©ç•Œé¢
                            if (iframeWrapper) {
                                iframeWrapper.style.display = 'none';
                            }
                            // æ˜¾ç¤ºçº¿è·¯é€‰æ‹©ç•Œé¢
                            showRouteSelector();
                            // åˆ‡æ¢çº¿è·¯åè‡ªåŠ¨æŠ˜å 
                            setTimeout(collapseButton, 300);
                        }
                        
                        isDragging = false;
                    }
                }
                
                // ç‚¹å‡»æŒ‰é’®å±•å¼€/æŠ˜å æˆ–æ‰§è¡Œåˆ‡æ¢çº¿è·¯
                routeChangeBtn.addEventListener('click', function(e) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘documentçš„ç‚¹å‡»äº‹ä»¶å¯¼è‡´ç«‹å³æŠ˜å 
                    e.stopPropagation();
                    
                    // å¦‚æœæ­£åœ¨æ‹–åŠ¨ï¼Œä¸æ‰§è¡Œç‚¹å‡»äº‹ä»¶
                    if (isDragging) {
                        e.preventDefault();
                        return;
                    }
                    
                    // å¦‚æœæŒ‰é’®æ˜¯æŠ˜å çŠ¶æ€ï¼Œå±•å¼€
                    if (!isExpanded) {
                        expandButton();
                        e.preventDefault();
                        return;
                    }
                    
                    // å¦‚æœæŒ‰é’®å·²å±•å¼€ï¼Œæ‰§è¡Œåˆ‡æ¢çº¿è·¯åŠŸèƒ½
                    if (isExpanded) {
                        // éšè—iframeï¼Œæ˜¾ç¤ºçº¿è·¯é€‰æ‹©ç•Œé¢
                        if (iframeWrapper) {
                            iframeWrapper.style.display = 'none';
                        }
                        // æ˜¾ç¤ºçº¿è·¯é€‰æ‹©ç•Œé¢
                        showRouteSelector();
                        // åˆ‡æ¢çº¿è·¯åè‡ªåŠ¨æŠ˜å 
                        setTimeout(collapseButton, 300);
                    }
                });
                
                // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ‹–åŠ¨ï¼‰
                routeChangeBtn.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
                
                // è§¦æ‘¸äº‹ä»¶ï¼ˆç”¨äºæ‹–åŠ¨ï¼‰
                routeChangeBtn.addEventListener('touchstart', startDrag, { passive: false });
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('touchend', endDrag);
                
                // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶æŠ˜å æŒ‰é’®
                function handleDocumentClick(e) {
                    // å¦‚æœæŒ‰é’®æ˜¯å±•å¼€çŠ¶æ€ï¼Œä¸”ç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®æœ¬èº«
                    if (isExpanded && !routeChangeBtn.contains(e.target)) {
                        // ç«‹å³æŠ˜å ï¼Œä¸éœ€è¦å»¶è¿Ÿ
                        collapseButton();
                    }
                }
                
                // ä½¿ç”¨æ•è·é˜¶æ®µï¼Œç¡®ä¿èƒ½æ•è·åˆ°æ‰€æœ‰ç‚¹å‡»äº‹ä»¶
                document.addEventListener('click', handleDocumentClick, true);
                
                // ä¹Ÿç›‘å¬è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
                document.addEventListener('touchend', function(e) {
                    if (isExpanded && !routeChangeBtn.contains(e.target)) {
                        collapseButton();
                    }
                }, true);
                
                // ç›‘å¬iframeå®¹å™¨çš„ç‚¹å‡»ï¼ˆå¤„ç†iframeå†…çš„ç‚¹å‡»ï¼‰
                const iframeContainer = document.querySelector('.iframe-container');
                if (iframeContainer) {
                    iframeContainer.addEventListener('click', function(e) {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯iframeå®¹å™¨åŒºåŸŸï¼Œä¸”æŒ‰é’®æ˜¯å±•å¼€çŠ¶æ€
                        if (isExpanded && !routeChangeBtn.contains(e.target)) {
                            collapseButton();
                        }
                    }, true);
                }
                
                // ç›‘å¬iframe wrapperçš„ç‚¹å‡»
                if (iframeWrapper) {
                    iframeWrapper.addEventListener('click', function(e) {
                        if (isExpanded && !routeChangeBtn.contains(e.target)) {
                            collapseButton();
                        }
                    }, true);
                }
                
                // ç›‘å¬bodyçš„ç‚¹å‡»ï¼ˆä½œä¸ºå¤‡ç”¨ï¼Œä½¿ç”¨å†’æ³¡é˜¶æ®µï¼‰
                document.body.addEventListener('click', function(e) {
                    if (isExpanded && !routeChangeBtn.contains(e.target)) {
                        // å»¶è¿Ÿä¸€ç‚¹ï¼Œé¿å…ä¸æŒ‰é’®ç‚¹å‡»å†²çª
                        setTimeout(function() {
                            if (isExpanded && !routeChangeBtn.contains(e.target)) {
                                collapseButton();
                            }
                        }, 50);
                    }
                }, false);
            }
            
            if (routeRefreshBtn) {
                routeRefreshBtn.addEventListener('click', function() {
                    routeRefreshBtn.classList.add('refreshing');
                    routeLatencies = {};
                    renderRouteList();
                    
                    testAllRoutes().then(function(fastestRoute) {
                        routeRefreshBtn.classList.remove('refreshing');
                        // è‡ªåŠ¨é€‰æ‹©æœ€å¿«çš„çº¿è·¯ï¼ˆä½†ä¸è‡ªåŠ¨è¿›å…¥ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ï¼‰
                        if (fastestRoute && !selectedRoute) {
                            selectedRoute = fastestRoute;
                            const routeItem = document.querySelector('[data-route-id="' + fastestRoute.id + '"]');
                            if (routeItem) {
                                routeItem.classList.add('selected');
                            }
                        }
                        renderRouteList();
                    });
                });
            }
            
            // åˆå§‹çŠ¶æ€ï¼šéšè—iframeï¼Œæ˜¾ç¤ºå®‰å…¨æ£€æµ‹é¡µé¢
            if (iframeWrapper) {
                iframeWrapper.style.display = 'none';
            }
            
            // ç¡®ä¿å®‰å…¨æ£€æµ‹é¡µé¢åœ¨åˆå§‹æ—¶æ˜¾ç¤ºå¹¶å¯åŠ¨æ£€æµ‹
            function initSecurityCheck() {
                if (securityCheck) {
                    securityCheck.style.display = 'flex';
                    const securityCheckContent = document.getElementById('securityCheckContent');
                    if (securityCheckContent) {
                        startSecurityCheck();
                    } else {
                        setTimeout(initSecurityCheck, 100);
                    }
                } else {
                    setTimeout(initSecurityCheck, 100);
                }
            }
            
            // æ ¹æ®æ–‡æ¡£çŠ¶æ€é€‰æ‹©å¯åŠ¨æ—¶æœº
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(initSecurityCheck, 100);
                });
            } else {
                setTimeout(initSecurityCheck, 100);
            }
            
            // å¤‡ç”¨å¯åŠ¨ï¼ˆç¡®ä¿ä¸€å®šä¼šæ‰§è¡Œï¼‰
            window.addEventListener('load', function() {
                if (securityCheck && securityCheck.style.display !== 'flex') {
                    initSecurityCheck();
                }
            });
        })();
    </script>
</body>
</html>